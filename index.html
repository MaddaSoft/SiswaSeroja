<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Antrian Surat Izin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        input[type="file"] { display: none; }
        .submenu {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-in-out;
        }
        .submenu.open {
            max-height: 500px; /* Cukup besar untuk menampilkan semua item */
        }
        .menu-item.active {
            background-color: #e0f2fe;
            color: #0c4a6e;
        }
        .menu-item.active svg.arrow {
            transform: rotate(90deg);
        }
        /* Animated Brand */
        .animated-brand {
            background: linear-gradient(90deg, #38bdf8, #3b82f6, #8b5cf6, #ec4899);
            background-size: 200% 200%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: gradient-animation 5s ease infinite;
        }
        @keyframes gradient-animation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        /* Dark Theme */
        .dark, .dark body { background-color: #0f172a; color: #cbd5e1; }
        .dark aside { background-color: #1e293b; border-color: #334155; }
        .dark main { background-color: #0f172a; }
        .dark h1, .dark h2, .dark .font-semibold { color: #f1f5f9; }
        .dark p, .dark label, .dark .text-slate-700 { color: #94a3b8; }
        .dark .menu-item { color: #cbd5e1; }
        .dark .menu-item:hover { background-color: #334155; }
        .dark #submenu-database button, .dark #submenu-database label { color: #94a3b8; }
        .dark #submenu-database button:hover, .dark #submenu-database label:hover { background-color: #334155; }
        .dark #search-form { background-color: #1e293b; border-color: #334155;}
        .dark input, .dark select { background-color: #334155; border-color: #475569; color: #f1f5f9; }
        .dark input::placeholder { color: #64748b; }
        .dark input:disabled { background-color: #334155; opacity: 0.5; }
        .dark #kelas { background-color: #0f172a; }
        .dark #queue-container { background-color: #1e293b; border-color: #334155; }
        .dark #queue-container tr { border-color: #334155; }
        .dark #queue-container thead { background-color: #334155; }
        .dark #queue-container tbody tr { background-color: #1e293b; }
        .dark #queue-container tbody tr:hover { background-color: #334155; }
        .dark .text-slate-800 { color: #f1f5f9; }
        .dark .text-slate-900 { color: #f8fafc; }
        .dark #manual-add-modal > div, .dark #confirm-modal > div, .dark #settings-modal > div { background-color: #1e293b; }
    </style>
</head>
<body class="bg-slate-100 text-slate-800">

    <div class="flex min-h-screen">
        <aside class="w-96 bg-white p-6 border-r border-slate-200 flex flex-col flex-shrink-0 h-screen">
            <p class="text-xs font-extrabold tracking-widest uppercase animated-brand mb-4">Madda Soft Production</p>
            <h1 class="text-2xl font-bold mb-1">Aplikasi Izin Siswa</h1>
            <p id="active-date-display" class="text-sm text-slate-500 mb-6">Selasa, 8 Juli 2025</p>
            
            <nav class="space-y-2">
                <button id="menu-database" class="menu-item w-full flex items-center justify-between p-3 rounded-lg text-slate-700 hover:bg-slate-100 transition-colors">
                    <span class="font-semibold">Database Siswa</span>
                    <svg class="arrow w-4 h-4 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                </button>
                <ul id="submenu-database" class="submenu space-y-1 mt-1 pl-4">
                    <li><button id="open-manual-add-modal" class="w-full text-left p-2 rounded-md text-slate-600 hover:bg-slate-100 text-sm flex items-center space-x-2"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg><span>Tambah Siswa Baru</span></button></li>
                    <li>
                        <label for="csv-file-input" class="w-full text-left p-2 rounded-md text-slate-600 hover:bg-slate-100 text-sm block cursor-pointer flex items-center space-x-2"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg><span>Impor dari .XLSX</span></label>
                        <input type="file" id="csv-file-input" accept=".xlsx">
                    </li>
                    <li><button id="download-template-button" class="w-full text-left p-2 rounded-md text-slate-600 hover:bg-slate-100 text-sm flex items-center space-x-2"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg><span>Unduh Template XLSX</span></button></li>
                    <li><button id="delete-database-button" class="w-full text-left p-2 rounded-md text-red-600 hover:bg-red-50 text-sm flex items-center space-x-2"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg><span>Hapus Database</span></button></li>
                </ul>

                <div class="pt-4">
                    <h2 class="font-semibold text-slate-700 p-3">Cari & Tambah Antrian</h2>
                    <form id="search-form" class="space-y-3 relative p-3">
                        <div>
                            <label for="search-nama" class="block text-xs font-medium text-slate-600">Nama Siswa</label>
                            <input type="text" id="search-nama" name="nama" autocomplete="off" placeholder="Ketik nama..." class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm focus:outline-none focus:border-sky-500 disabled:bg-slate-50">
                            <div id="autocomplete-results" class="absolute z-10 w-full bg-white border border-slate-200 rounded-md mt-1 max-h-48 overflow-y-auto shadow-lg hidden"></div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="kelas" class="block text-xs font-medium text-slate-600">Kelas</label>
                                <input type="text" id="kelas" name="kelas" readonly class="mt-1 block w-full px-3 py-2 bg-slate-100 border-slate-300 rounded-md text-sm">
                            </div>
                             <div>
                                <label for="wali" class="block text-xs font-medium text-slate-600">Nama Orang Tua / Wali</label>
                                <input type="text" id="wali" name="wali" required placeholder="Nama Wali" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm focus:outline-none focus:border-sky-500">
                            </div>
                        </div>
                        <div>
                            <label for="keterangan" class="block text-xs font-medium text-slate-600">Keterangan</label>
                            <div class="flex items-center space-x-2 mt-1">
                                <select id="keterangan" name="keterangan" class="block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm focus:outline-none focus:border-sky-500">
                                    <option>Sakit</option>
                                    <option>Izin</option>
                                </select>
                                <button type="submit" id="add-button" class="px-4 py-2 bg-indigo-600 text-white font-semibold rounded-md hover:bg-indigo-700 disabled:bg-indigo-300 whitespace-nowrap">
                                    + Tambah
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </nav>
            
            <div class="mt-auto flex justify-between items-center text-xs text-slate-400 pt-4 border-t">
                <span id="database-info">Database kosong.</span>
                <button id="open-settings-modal" class="p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-700">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                </button>
            </div>
        </aside>

        <main class="flex-grow bg-slate-50 p-8 flex flex-col h-screen">
             <div class="flex justify-between items-center mb-4">
                <h2 id="queue-title" class="text-xl font-semibold">Daftar Antrian</h2>
                <div class="flex items-center space-x-4">
                    <button id="reset-queue-button" class="text-sm text-orange-600 hover:text-orange-800 font-semibold">Hapus Data Hari Ini</button>
                    <button id="print-pdf-button" class="bg-blue-600 text-white font-bold py-2 px-5 rounded-md hover:bg-blue-700 text-sm">Cetak Laporan</button>
                    <button id="print-slips-button" class="bg-emerald-600 text-white font-bold py-2 px-5 rounded-md hover:bg-emerald-700 text-sm">Cetak Izin Siswa</button>
                </div>
            </div>
            <div id="queue-container" class="flex-grow overflow-y-auto bg-white rounded-lg border border-slate-200 shadow-sm">
                </div>
            <footer class="text-center text-xs text-slate-400 pt-4">
                Design & Creative 2025 By : Madda soft Feat Gemini
            </footer>
        </main>
    </div>

    <!-- Manual Add Student Modal -->
    <div id="manual-add-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Tambah Siswa Baru ke Database</h2>
                <button id="close-manual-add-modal-button" class="text-slate-500 hover:text-slate-800">&times;</button>
            </div>
            <form id="manual-add-form" class="space-y-4">
                    <p class="text-sm text-slate-600">Siswa yang ditambahkan di sini akan langsung bisa dicari.</p>
                    <div>
                        <label for="manual-nama" class="block text-sm font-medium text-slate-700">Nama Siswa Baru</label>
                        <input type="text" id="manual-nama" placeholder="Nama Lengkap" required class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm">
                    </div>
                    <div>
                        <label for="manual-kelas" class="block text-sm font-medium text-slate-700">Kelas</label>
                        <input type="text" id="manual-kelas" placeholder="Contoh: 9A" required class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm">
                    </div>
                    <button type="submit" class="w-full bg-green-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-green-700">Tambah ke Database</button>
            </form>
        </div>
    </div>

    <!-- Confirmation / Message Modal (Reused) -->
    <div id="confirm-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm">
            <h3 id="confirm-title" class="text-lg font-bold mb-4">Konfirmasi Aksi</h3>
            <p id="confirm-message" class="text-sm text-slate-600 mb-6">Apakah Anda yakin?</p>
            <div class="flex justify-end space-x-3">
                <button id="confirm-cancel-btn" class="px-4 py-2 rounded-md text-sm font-medium bg-slate-100 hover:bg-slate-200">Batal</button>
                <button id="confirm-ok-btn" class="px-4 py-2 rounded-md text-sm font-medium text-white bg-red-600 hover:bg-red-700">Ya, Lanjutkan</button>
            </div>
        </div>
    </div>
    
    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-md">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold">Pengaturan</h2>
                <button id="close-settings-modal-button" class="text-slate-500 hover:text-slate-800">&times;</button>
            </div>
            <div class="space-y-6">
                <div>
                    <h3 class="font-semibold mb-2">Pengaturan Tanggal Laporan</h3>
                    <div class="flex items-center space-x-4">
                        <label class="flex items-center space-x-2">
                            <input type="radio" name="date-setting" value="auto" checked>
                            <span>Otomatis (Hari Ini)</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="radio" name="date-setting" value="manual">
                            <span>Manual</span>
                        </label>
                    </div>
                    <input type="date" id="manual-date-input" class="mt-2 w-full p-2 border rounded-md hidden">
                </div>
                <div>
                    <h3 class="font-semibold mb-2">Tema Tampilan</h3>
                     <div class="flex items-center space-x-4">
                        <label class="flex items-center space-x-2">
                            <input type="radio" name="theme-setting" value="light" checked>
                            <span>Cerah</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="radio" name="theme-setting" value="dark">
                            <span>Gelap</span>
                        </label>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
    function initializeApp() {
        // --- STATE MANAGEMENT ---
        // Array to store all student data loaded from local storage or added manually.
        let studentDatabase = [];
        // Array to store students currently in the daily permission queue.
        let printQueue = [];
        // Stores the student object selected from the autocomplete search.
        let selectedStudent = null;
        // Callback function for the confirmation modal.
        let onConfirmCallback = null;
        // The date currently active for reports and queue display.
        let activeDate = new Date();
        // Mode for date selection: 'auto' (today) or 'manual'.
        let dateMode = 'auto';
        // Current theme: 'light' or 'dark'. Loaded from local storage.
        let currentTheme = localStorage.getItem('appTheme') || 'light';

        // --- DOM ELEMENTS ---
        // Caching references to frequently used DOM elements for performance.
        const appTitle = document.querySelector('h1');
        const appVersion = document.querySelector('p.text-sm.text-slate-500');
        const activeDateDisplay = document.getElementById('active-date-display');
        const menuDatabase = document.getElementById('menu-database');
        const submenuDatabase = document.getElementById('submenu-database');
        const fileInput = document.getElementById('csv-file-input');
        const downloadTemplateButton = document.getElementById('download-template-button');
        const deleteDatabaseButton = document.getElementById('delete-database-button');
        const databaseInfo = document.getElementById('database-info');
        const searchForm = document.getElementById('search-form');
        const searchInput = document.getElementById('search-nama');
        const classInput = document.getElementById('kelas');
        const waliInput = document.getElementById('wali');
        const reasonSelect = document.getElementById('keterangan');
        const addButton = document.getElementById('add-button');
        const autocompleteResults = document.getElementById('autocomplete-results');
        const queueTitle = document.getElementById('queue-title');
        const queueContainer = document.getElementById('queue-container');
        const resetQueueButton = document.getElementById('reset-queue-button');
        const printPdfButton = document.getElementById('print-pdf-button');
        const printSlipsButton = document.getElementById('print-slips-button');
        
        const manualAddForm = document.getElementById('manual-add-form');
        const openManualAddModalBtn = document.getElementById('open-manual-add-modal');
        const manualAddModal = document.getElementById('manual-add-modal');
        const closeModalBtn = document.getElementById('close-manual-add-modal-button');

        const confirmModal = document.getElementById('confirm-modal');
        const confirmTitle = document.getElementById('confirm-title');
        const confirmMessage = document.getElementById('confirm-message');
        const confirmOkBtn = document.getElementById('confirm-ok-btn');
        const confirmCancelBtn = document.getElementById('confirm-cancel-btn');

        const openSettingsModalBtn = document.getElementById('open-settings-modal');
        const settingsModal = document.getElementById('settings-modal');
        const closeSettingsModalBtn = document.getElementById('close-settings-modal-button');
        const dateSettingRadios = document.querySelectorAll('input[name="date-setting"]');
        const manualDateInput = document.getElementById('manual-date-input');
        const themeSettingRadios = document.querySelectorAll('input[name="theme-setting"]');
        
        // --- INITIAL UI STATE ---
        // Sets the initial display state of UI elements and loads data.
        function setInitialUIState() {
            if (appTitle) appTitle.textContent = "Aplikasi Izin Siswa";
            if (appVersion) appVersion.textContent = "Versi 2.1 (XLSX Support)";
            if (searchInput) searchInput.disabled = true; // Disable search until database is loaded/populated.
            if (addButton) addButton.disabled = true; // Disable add button initially.
            
            applyTheme(currentTheme); // Apply the saved or default theme.
            updateDateDisplay(); // Display the current active date.
            loadDataFromLocalStorage(); // Load student and queue data from local storage.
        }

        // --- RENDER FUNCTIONS ---
        // Renders the current state of the permission queue into the table.
        function renderQueue() {
            if (!queueContainer || !queueTitle) return;
            queueContainer.innerHTML = ''; // Clear existing table content.
            queueTitle.textContent = `Daftar Antrian (${printQueue.length} Siswa)`; // Update queue title.

            if (printQueue.length === 0) {
                // Display a message if the queue is empty.
                queueContainer.innerHTML = `<div class="h-full flex items-center justify-center"><p class="text-base text-slate-400">Antrian kosong.</p></div>`;
                return;
            }
            
            // Create the table structure.
            const table = document.createElement('table');
            table.className = 'w-full text-sm text-left text-slate-500';
            table.innerHTML = `
                <thead class="text-xs text-slate-700 uppercase bg-slate-100 sticky top-0 dark:bg-slate-700 dark:text-slate-300">
                    <tr>
                        <th scope="col" class="px-6 py-3 w-12">No</th>
                        <th scope="col" class="px-6 py-3">Nama Siswa</th>
                        <th scope="col" class="px-6 py-3">Kelas</th>
                        <th scope="col" class="px-6 py-3">Orang Tua/Wali</th>
                        <th scope="col" class="px-6 py-3">Keterangan</th>
                        <th scope="col" class="px-6 py-3 text-center">Aksi</th>
                    </tr>
                </thead>
                <tbody id="queue-table-body"></tbody>
            `;
            
            const tableBody = table.querySelector('#queue-table-body');
            // Populate the table with students from the printQueue.
            printQueue.forEach((student, index) => {
                const row = document.createElement('tr');
                row.className = 'bg-white border-b hover:bg-slate-50 dark:bg-slate-800 dark:border-slate-700 dark:hover:bg-slate-700';
                row.innerHTML = `
                    <td class="px-6 py-4 font-medium text-slate-900 dark:text-slate-100">${index + 1}</td>
                    <td class="px-6 py-4 font-semibold text-slate-800 dark:text-slate-200">${student.name}</td>
                    <td class="px-6 py-4">${student.class}</td>
                    <td class="px-6 py-4">${student.wali}</td>
                    <td class="px-6 py-4"><span class="font-medium text-amber-600">${student.reason}</span></td>
                    <td class="px-6 py-4 text-center">
                        <button data-index="${index}" class="remove-queue-btn text-red-500 hover:text-red-700 font-semibold">Hapus</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            
            queueContainer.appendChild(table);
        }
        
        // --- MODAL & NOTIFICATION LOGIC ---
        // Displays a custom modal for confirmations or simple messages.
        // type: 'confirm' (shows Yes/No buttons) or 'message' (shows only OK button).
        // title: The title of the modal.
        // message: The main content message.
        // onConfirm: Callback function executed if 'Ya, Lanjutkan' (for confirm) or 'OK' (for message) is clicked.
        function showCustomModal(type, title, message, onConfirm = null) {
            if (!confirmModal || !confirmTitle || !confirmMessage || !confirmOkBtn || !confirmCancelBtn) return;

            confirmTitle.textContent = title;
            confirmMessage.textContent = message;
            onConfirmCallback = onConfirm;

            if (type === 'message') {
                confirmOkBtn.textContent = 'OK';
                confirmOkBtn.className = 'px-4 py-2 rounded-md text-sm font-medium text-white bg-blue-600 hover:bg-blue-700';
                confirmCancelBtn.classList.add('hidden'); // Hide cancel button for messages
            } else { // type === 'confirm'
                confirmOkBtn.textContent = 'Ya, Lanjutkan';
                confirmOkBtn.className = 'px-4 py-2 rounded-md text-sm font-medium text-white bg-red-600 hover:bg-red-700';
                confirmCancelBtn.classList.remove('hidden'); // Show cancel button for confirmations
            }

            confirmModal.classList.remove('hidden');
            confirmModal.classList.add('flex');
        }

        // Helper function for showing simple messages.
        function showMessage(title, message) {
            showCustomModal('message', title, message);
        }

        // Helper function for showing confirmation prompts.
        function showConfirmation(title, message, onConfirm) {
            showCustomModal('confirm', title, message, onConfirm);
        }

        function hideConfirmation() {
            if (!confirmModal) return;
            confirmModal.classList.add('hidden');
            confirmModal.classList.remove('flex');
            onConfirmCallback = null; // Clear the callback.
        }

        // --- DATA PERSISTENCE (localStorage) ---
        // Saves the current student database and print queue to local storage.
        function saveDataToLocalStorage() {
            localStorage.setItem('studentDatabase', JSON.stringify(studentDatabase));
            localStorage.setItem('printQueue', JSON.stringify(printQueue));
            console.log("Data saved to localStorage.");
        }

        // Loads student database and print queue from local storage.
        function loadDataFromLocalStorage() {
            const storedStudents = localStorage.getItem('studentDatabase');
            const storedQueue = localStorage.getItem('printQueue');

            if (storedStudents) {
                try {
                    studentDatabase = JSON.parse(storedStudents);
                    updateDatabaseInfo(); // Update database info after loading.
                } catch (e) {
                    console.error("Error parsing studentDatabase from localStorage", e);
                    studentDatabase = []; // Reset if parsing fails.
                    showMessage('Error', 'Gagal memuat database siswa dari penyimpanan lokal. Data mungkin rusak.');
                }
            }
            if (storedQueue) {
                try {
                    printQueue = JSON.parse(storedQueue);
                    renderQueue(); // Render queue after loading.
                } catch (e) {
                    console.error("Error parsing printQueue from localStorage", e);
                    printQueue = []; // Reset if parsing fails.
                    showMessage('Error', 'Gagal memuat antrian izin dari penyimpanan lokal. Data mungkin rusak.');
                }
            }
            console.log("Data loaded from localStorage.");
        }

        // --- CORE LOGIC ---
        // Generates a PDF of individual permission slips for each student in the queue.
        function generateSlipsPDF() {
            if (printQueue.length === 0) {
                showMessage("Antrian Kosong", "Daftar antrian kosong. Tidak ada data untuk dicetak.");
                return;
            }

            const { jsPDF } = window.jspdf;
            // Initialize jsPDF in landscape A4 format.
            const doc = new jsPDF({ orientation: 'landscape', unit: 'mm', format: 'a4' });
            const pageW = doc.internal.pageSize.getWidth();
            const pageH = doc.internal.pageSize.getHeight();
            const panelW = pageW / 3; // Divide page into 3 columns for slips.
            const panelH = pageH / 2; // Divide page into 2 rows for slips.
            const margin = 8; // Margin within each slip panel.

            // Function to draw a single permission slip.
            const drawSlip = (x, y, student) => {
                // Draw border for the slip panel.
                doc.setDrawColor(150, 150, 150);
                doc.rect(x, y, panelW, panelH);

                const contentX = x + margin;
                const contentY = y + margin;
                const contentW = panelW - (margin * 2);
                let currentY = contentY;

                // Slip Title
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                const title = "SURAT IJIN TIDAK MASUK SEKOLAH";
                const titleWidth = doc.getTextWidth(title);
                doc.text(title, x + (panelW / 2), currentY, { align: 'center' });
                // Underline the title.
                const underlineY = currentY + 1;
                doc.setLineWidth(0.5);
                doc.line(x + (panelW / 2) - (titleWidth / 2), underlineY, x + (panelW / 2) + (titleWidth / 2), underlineY);
                currentY += 8;

                // First paragraph of the slip.
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                const p1 = "Surat ini menerangkan bahwa siswa tersebut dibawah ini telah diijinkan oleh orangtua/walinya untuk tidak masuk sekolah.";
                doc.text(p1, contentX, currentY, { maxWidth: contentW });
                currentY += 15;

                // Student Data
                doc.text("Nama", contentX, currentY);
                doc.text(`: ${student.name}`, contentX + 20, currentY);
                currentY += 6;
                doc.text("Kelas", contentX, currentY);
                doc.text(`: ${student.class}`, contentX + 20, currentY);
                currentY += 6;
                doc.text("Keterangan", contentX, currentY);
                doc.text(`: ${student.reason}`, contentX + 20, currentY);
                currentY += 12;

                // Second paragraph.
                const p2 = "Mohon diteruskan kepada petugas presensi untuk dilaksanakan. Terima kasih.";
                doc.text(p2, contentX, currentY, { maxWidth: contentW });

                // Signature section.
                const signX = x + panelW - margin;
                const signY = y + panelH - margin;
                const formattedDate = activeDate.toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' });
                
                doc.text(`Jatirogo, ${formattedDate}`, signX, signY - 20, { align: 'right' });
                doc.text("Petugas,", signX, signY - 15, { align: 'right' });
                doc.text("Meri Wahyudi", signX, signY, { align: 'right' });
            };

            // Iterate through the print queue and draw slips.
            printQueue.forEach((student, index) => {
                const pageIndex = Math.floor(index / 6); // 6 slips per page (3 columns * 2 rows).
                if (pageIndex > 0 && index % 6 === 0) {
                    doc.addPage(); // Add new page for every 6 slips.
                }
                
                const slipIndexOnPage = index % 6;
                const col = slipIndexOnPage % 3; // Determine column (0, 1, or 2).
                const row = Math.floor(slipIndexOnPage / 3); // Determine row (0 or 1).

                const x = col * panelW;
                const y = row * panelH;

                drawSlip(x, y, student);
            });
            
            const fileName = `surat-izin-${activeDate.toISOString().slice(0,10)}.pdf`;
            doc.output('dataurlnewwindow'); // Open the generated PDF in a new tab.
        }

        // Generates a PDF report of all students in the current queue.
        function generateReportPDF() {
            if (printQueue.length === 0) {
                showMessage("Antrian Kosong", "Daftar antrian kosong. Tidak ada data untuk dicetak.");
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });

            const tableColumn = ["No", "Nama Siswa", "Kelas", "Orang Tua/Wali", "Keterangan"];
            const tableRows = printQueue.map((student, index) => [
                index + 1, student.name, student.class, student.wali, student.reason
            ]);
            
            const formattedDate = activeDate.toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' });
            const docTitle = "Laporan Ijin Siswa";
            const dateSubTitle = `Tanggal: ${formattedDate}`;
            const fileName = `laporan-izin-${activeDate.toISOString().slice(0,10)}.pdf`;

            const pageWidth = doc.internal.pageSize.getWidth();
            doc.setFontSize(18);
            doc.text(docTitle, pageWidth / 2, 15, { align: 'center' });
            doc.setFontSize(12);
            doc.text(dateSubTitle, pageWidth / 2, 22, { align: 'center' });

            doc.autoTable({
                head: [tableColumn],
                body: tableRows,
                startY: 30, // Start table below the title and subtitle.
                theme: 'grid',
                headStyles: { fillColor: [241, 245, 249], textColor: [20, 20, 20] },
                styles: { font: 'Inter', fontSize: 12 },
                margin: { top: 10, right: 10, bottom: 10, left: 10 }
            });
            
            doc.output('dataurlnewwindow'); // Open the generated PDF in a new tab.
        }

        // Downloads an XLSX template file for importing student data.
        function downloadTemplate() {
            const headers = [
                "Nama",
                "Kelas",
                "Wali",
                "Nomor HP Wali"
            ];

            const data = [headers]; // Only headers for an empty template.

            // Create a new worksheet from the array of arrays.
            const ws = XLSX.utils.aoa_to_sheet(data);

            // Create a new workbook.
            const wb = XLSX.utils.book_new();
            // Append the worksheet to the workbook with a sheet name.
            XLSX.utils.book_append_sheet(wb, ws, "Data Siswa");

            // Write the XLSX file and trigger download.
            XLSX.writeFile(wb, "template_data_siswa.xlsx");

            showMessage('Template Diunduh', 'Template Excel "template_data_siswa.xlsx" berhasil diunduh.');
        }
        
        // Handles the upload of an XLSX file to import student data.
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) {
                showMessage('Peringatan', 'Tidak ada file yang dipilih.');
                event.target.value = ''; // Reset input file.
                return;
            }

            const fileName = file.name;
            const fileExtension = fileName.split('.').pop().toLowerCase();

            if (fileExtension !== 'xlsx') {
                showMessage('Format File Salah', 'Harap unggah file Excel dengan ekstensi .xlsx.');
                event.target.value = ''; // Reset input file.
                return;
            }

            const reader = new FileReader();

            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });

                const sheetName = workbook.SheetNames[0]; // Get the first sheet.
                const worksheet = workbook.Sheets[sheetName];

                // Convert worksheet to JSON, treating the first row as headers.
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, raw: false });

                if (jsonData.length < 2) { // Minimum: header row + one data row.
                    showMessage('File Kosong', 'File Excel kosong atau tidak memiliki data yang cukup.');
                    event.target.value = '';
                    return;
                }

                const headers = jsonData[0]; // First row contains headers.
                const studentsDataRows = jsonData.slice(1); // Student data starts from the second row.

                // Validate required headers: Only 'Nama' and 'Kelas' are mandatory.
                const requiredHeaders = ['Nama', 'Kelas'];
                const missingHeaders = requiredHeaders.filter(header => !headers.includes(header));

                if (missingHeaders.length > 0) {
                    showMessage('Header Tidak Lengkap', `File Excel tidak memiliki kolom yang diperlukan: ${missingHeaders.join(', ')}. Harap gunakan template yang benar.`);
                    event.target.value = '';
                    return;
                }

                const newStudents = [];
                let duplicatesFound = 0;
                // Create a Set of existing student names (case-insensitive) for duplicate checking.
                const seenNamesInDatabase = new Set(studentDatabase.map(s => s.name.toLowerCase()));

                studentsDataRows.forEach(row => {
                    // Get data based on header index.
                    const nameIndex = headers.indexOf('Nama');
                    const classIndex = headers.indexOf('Kelas');
                    const waliIndex = headers.indexOf('Wali'); // This will be -1 if 'Wali' column is not present
                    const nomorHpWaliIndex = headers.indexOf('Nomor HP Wali'); // This will be -1 if 'Nomor HP Wali' column is not present

                    const name = row[nameIndex] ? String(row[nameIndex]).trim() : '';
                    const studentClass = row[classIndex] ? String(row[classIndex]).trim() : '';
                    // If column index is -1 (column not found) or value is empty, default to empty string.
                    const wali = waliIndex !== -1 && row[waliIndex] ? String(row[waliIndex]).trim() : '';
                    const nomorHpWali = nomorHpWaliIndex !== -1 && row[nomorHpWaliIndex] ? String(row[nomorHpWaliIndex]).trim() : '';

                    // Basic validation: name and class cannot be empty.
                    if (name && studentClass) {
                        // Check for duplicates before adding.
                        if (!seenNamesInDatabase.has(name.toLowerCase())) {
                            seenNamesInDatabase.add(name.toLowerCase()); // Add to set to prevent duplicates from the same file.
                            newStudents.push({
                                name: name,
                                class: studentClass,
                                wali: wali,
                                nomorHpWali: nomorHpWali
                            });
                        } else {
                            duplicatesFound++;
                        }
                    }
                });

                if (newStudents.length > 0) {
                    // Merge new students with the existing database.
                    studentDatabase = [...studentDatabase, ...newStudents];
                    saveDataToLocalStorage(); // Save changes to local storage.
                    updateDatabaseInfo(); // Update database info display.
                    let successMessage = `Berhasil mengimpor ${newStudents.length} siswa baru dari file Excel.`;
                    if (duplicatesFound > 0) {
                        successMessage += `\n${duplicatesFound} data duplikat (nama yang sama) diabaikan.`;
                    }
                    showMessage('Impor Berhasil', successMessage);
                } else {
                    showMessage('Tidak Ada Siswa Valid', 'Tidak ada siswa valid yang ditemukan di file Excel untuk diimpor.');
                }
                event.target.value = ''; // Reset file input after processing.
            };

            reader.onerror = function(ex) {
                showMessage('Error Membaca File', 'Gagal membaca file. Pastikan format file Excel Anda benar.');
                console.error('File Reader Error:', ex);
                event.target.value = ''; // Reset input file.
            };

            reader.readAsArrayBuffer(file);
        }

        // Handles student search input and displays autocomplete results.
        function handleSearch(e) {
            const query = e.target.value.toLowerCase();
            if (!autocompleteResults) return;
            autocompleteResults.innerHTML = ''; // Clear previous results.

            if (query.length < 1) {
                autocompleteResults.classList.add('hidden');
                // Clear related inputs and reset selected student if search is empty.
                if (classInput) classInput.value = '';
                if (waliInput) waliInput.value = '';
                selectedStudent = null;
                if (addButton) addButton.disabled = true;
                return;
            }

            // Filter student database for matches (up to 10 results).
            const matches = studentDatabase.filter(s => s.name.toLowerCase().includes(query)).slice(0, 10);
            
            if (matches.length > 0) {
                autocompleteResults.classList.remove('hidden');
                matches.forEach(match => {
                    const item = document.createElement('div');
                    item.className = 'autocomplete-item p-2 hover:bg-sky-500 hover:text-white cursor-pointer dark:hover:bg-blue-700';
                    item.textContent = `${match.name} (${match.class})`;
                    // Store full student data in dataset for easy retrieval.
                    item.dataset.name = match.name;
                    item.dataset.class = match.class;
                    item.dataset.wali = match.wali || '';
                    item.dataset.nomorHpWali = match.nomorHpWali || '';
                    autocompleteResults.appendChild(item);
                });
            } else {
                autocompleteResults.classList.add('hidden');
            }
        }
        
        // Selects a student from the autocomplete results and populates the form.
        function selectStudentFromSearch(student) {
            selectedStudent = student;
            if (searchInput) searchInput.value = student.name;
            if (classInput) classInput.value = student.class;
            if (waliInput) waliInput.value = student.wali || ''; // Populate wali if available.
            if (autocompleteResults) autocompleteResults.classList.add('hidden');
            if (addButton) addButton.disabled = false; // Enable add button.
        }

        // Adds the selected student to the daily permission queue.
        function addToQueue(event) {
            event.preventDefault(); // Prevent form submission.
            if (!selectedStudent) { 
                showMessage('Peringatan', 'Pilih siswa dari hasil pencarian terlebih dahulu.'); 
                return; 
            }
            const waliName = waliInput.value.trim();
            if(!waliName) { 
                showMessage('Peringatan', 'Nama Orang Tua / Wali harus diisi.'); 
                return; 
            }
            // Check if student is already in the queue.
            const isAlreadyInQueue = printQueue.some(student => student.name.toLowerCase() === selectedStudent.name.toLowerCase());
            if (isAlreadyInQueue) {
                showMessage('Duplikat Antrian', `Siswa bernama "${selectedStudent.name}" sudah ada di dalam antrian.`);
                return;
            }
            // Add student to queue with reason and wali name.
            printQueue.push({ ...selectedStudent, reason: reasonSelect.value, wali: waliName });
            saveDataToLocalStorage(); // Save updated queue.
            selectedStudent = null; // Clear selected student.
            if (searchForm) searchForm.reset(); // Reset search form.
            if (addButton) addButton.disabled = true; // Disable add button.
            renderQueue(); // Re-render the queue table.
            // Clear class and wali inputs.
            if (classInput) classInput.value = '';
            if (waliInput) waliInput.value = '';
        }

        // Removes a student from the permission queue by index.
        function removeFromQueue(index) {
            printQueue.splice(index, 1); // Remove student from array.
            saveDataToLocalStorage(); // Save updated queue.
            renderQueue(); // Re-render the queue table.
        }

        // Resets (clears) the entire daily permission queue.
        function resetQueue() {
            showConfirmation('Hapus Data Hari Ini?', 'Anda yakin ingin menghapus semua data antrian hari ini? Ini tidak akan menghapus database siswa.', () => {
                printQueue = []; // Clear the queue.
                saveDataToLocalStorage(); // Save empty queue.
                renderQueue(); // Re-render (will show empty message).
                showMessage('Data Dihapus', 'Data antrian hari ini telah dihapus.');
            });
        }

        // Deletes the entire student database.
        function deleteDatabase() {
            showConfirmation('Hapus Seluruh Database?', 'PERINGATAN: Aksi ini tidak bisa dibatalkan. Seluruh data siswa yang dimuat akan hilang.', () => {
                studentDatabase = []; // Clear the student database.
                printQueue = []; // Also clear the queue as database is gone.
                saveDataToLocalStorage(); // Save empty database and queue.
                if (searchInput) searchInput.value = ''; // Clear search input.
                updateDatabaseInfo(); // Update database info.
                renderQueue(); // Re-render queue (will be empty).
                showMessage('Database Dihapus', 'Database telah dihapus.');
            });
        }

        // Adds a new student manually to the student database.
        function addStudentToDatabase(event) {
            event.preventDefault();
            const newNameInput = document.getElementById('manual-nama');
            const newClassInput = document.getElementById('manual-kelas');
            if (!newNameInput || !newClassInput) return;
            const newName = newNameInput.value.trim();
            const newClass = newClassInput.value.trim();

            if (!newName || !newClass) { 
                showMessage('Input Kosong', 'Nama dan Kelas siswa baru tidak boleh kosong.'); 
                return; 
            }
            // Check for duplicate names in the database.
            if (studentDatabase.some(s => s.name.toLowerCase() === newName.toLowerCase())) {
                showMessage('Duplikat Siswa', 'Siswa dengan nama ini sudah ada di database.');
                return;
            }
            // Add new student with default empty wali/nomorHpWali.
            studentDatabase.push({ name: newName, class: newClass, wali: '', nomorHpWali: '' });
            saveDataToLocalStorage(); // Save updated database.
            updateDatabaseInfo(); // Update database info display.
            showMessage('Siswa Ditambahkan', `Siswa "${newName}" berhasil ditambahkan ke database.`);
            if (manualAddForm) manualAddForm.reset(); // Reset manual add form.
            if (manualAddModal) manualAddModal.classList.add('hidden'); // Hide modal.
        }

        // Updates the display showing the number of students in the database.
        function updateDatabaseInfo() {
            if (databaseInfo) databaseInfo.textContent = `${studentDatabase.length} siswa di database.`;
            if (searchInput) {
                searchInput.disabled = studentDatabase.length === 0; // Enable/disable search based on database size.
                if(studentDatabase.length > 0) searchInput.focus(); // Focus search if database has students.
            }
        }
        
        // Updates the displayed active date.
        function updateDateDisplay() {
            if (!activeDateDisplay) return;
            activeDateDisplay.textContent = activeDate.toLocaleDateString('id-ID', {
                weekday: 'long', day: 'numeric', month: 'long', year: 'numeric'
            });
        }
        
        // Applies the selected theme (light/dark) to the document.
        function applyTheme(theme) {
            if (theme === 'dark') {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
            localStorage.setItem('appTheme', theme); // Save theme preference.
            const themeRadio = document.querySelector(`input[name="theme-setting"][value="${theme}"]`);
            if(themeRadio) themeRadio.checked = true; // Set the correct radio button.
        }

        // --- EVENT LISTENERS ---
        // Toggle submenu visibility.
        if (menuDatabase) menuDatabase.addEventListener('click', () => {
            if (submenuDatabase) submenuDatabase.classList.toggle('open');
            menuDatabase.classList.toggle('active');
        });
        // Handle XLSX file upload.
        if (fileInput) fileInput.addEventListener('change', handleFileUpload);
        // Download XLSX template.
        if (downloadTemplateButton) downloadTemplateButton.addEventListener('click', downloadTemplate);
        // Delete entire student database.
        if (deleteDatabaseButton) deleteDatabaseButton.addEventListener('click', deleteDatabase);
        // Handle search input for autocomplete.
        if (searchInput) searchInput.addEventListener('input', handleSearch);
        // Add selected student to queue on form submission.
        if (searchForm) searchForm.addEventListener('submit', addToQueue);
        // Reset daily queue.
        if (resetQueueButton) resetQueueButton.addEventListener('click', resetQueue);
        // Print report PDF.
        if (printPdfButton) printPdfButton.addEventListener('click', generateReportPDF);
        // Print individual slips PDF.
        if (printSlipsButton) printSlipsButton.addEventListener('click', generateSlipsPDF);
        
        // Handle manual add student form submission.
        if (manualAddForm) manualAddForm.addEventListener('submit', addStudentToDatabase);
        // Open manual add modal.
        if (openManualAddModalBtn) openManualAddModalBtn.addEventListener('click', () => {
            manualAddModal.classList.remove('hidden');
            document.getElementById('manual-nama').focus(); // Focus on first input.
        });
        // Close manual add modal.
        if (closeModalBtn) closeModalBtn.addEventListener('click', () => manualAddModal.classList.add('hidden'));
        // Close manual add modal when clicking outside.
        if (manualAddModal) manualAddModal.addEventListener('click', (e) => {
            if (e.target === manualAddModal) manualAddModal.classList.add('hidden');
        });

        // Event delegation for removing students from the queue.
        if (queueContainer) queueContainer.addEventListener('click', function(e) {
            if (e.target && e.target.classList.contains('remove-queue-btn')) {
                const index = parseInt(e.target.dataset.index, 10);
                if (!isNaN(index)) removeFromQueue(index);
            }
        });
        
        // Event delegation for selecting autocomplete results.
        if (autocompleteResults) autocompleteResults.addEventListener('click', function(e) {
            if (e.target && e.target.classList.contains('autocomplete-item')) {
                // Construct student object from dataset attributes.
                const student = {
                    name: e.target.dataset.name,
                    class: e.target.dataset.class,
                    wali: e.target.dataset.wali || '',
                    nomorHpWali: e.target.dataset.nomorHpWali || ''
                };
                selectStudentFromSearch(student);
            }
        });

        // Hide autocomplete results when clicking outside the search form.
        document.addEventListener('click', (e) => {
            if (searchForm && !searchForm.contains(e.target) && autocompleteResults) {
                autocompleteResults.classList.add('hidden');
            }
        });

        // Handle OK button click in the confirmation/message modal.
        if (confirmOkBtn) confirmOkBtn.addEventListener('click', () => {
            // Check if it's a simple message (cancel button hidden) or a confirmation.
            if (confirmCancelBtn.classList.contains('hidden')) { 
                hideConfirmation(); // Just close for messages.
            } else { 
                if (typeof onConfirmCallback === 'function') {
                    onConfirmCallback(); // Execute callback for confirmations.
                }
                hideConfirmation();
            }
        });
        // Handle Cancel button click in the confirmation modal.
        if (confirmCancelBtn) confirmCancelBtn.addEventListener('click', hideConfirmation);

        // Settings Modal Listeners
        // Open settings modal.
        if(openSettingsModalBtn) openSettingsModalBtn.addEventListener('click', () => {
            settingsModal.classList.remove('hidden');
            // Set radio buttons based on current settings.
            document.querySelector(`input[name="date-setting"][value="${dateMode}"]`).checked = true;
            if (dateMode === 'manual') {
                manualDateInput.classList.remove('hidden');
                manualDateInput.valueAsDate = activeDate || new Date(); // Set manual date input to current active date.
            } else {
                manualDateInput.classList.add('hidden');
            }
            document.querySelector(`input[name="theme-setting"][value="${currentTheme}"]`).checked = true;
        });
        // Close settings modal.
        if(closeSettingsModalBtn) closeSettingsModalBtn.addEventListener('click', () => settingsModal.classList.add('hidden'));
        // Close settings modal when clicking outside.
        if(settingsModal) settingsModal.addEventListener('click', (e) => {
            if(e.target === settingsModal) settingsModal.classList.add('hidden');
        });

        // Handle date setting radio button changes.
        dateSettingRadios.forEach(radio => {
            radio.addEventListener('change', (e) => {
                dateMode = e.target.value;
                if (dateMode === 'manual') {
                    manualDateInput.classList.remove('hidden');
                    manualDateInput.valueAsDate = activeDate || new Date(); // Set manual date input.
                    activeDate = new Date(manualDateInput.valueAsDate.getTime() + manualDateInput.valueAsDate.getTimezoneOffset() * 60000); // Adjust for timezone
                } else {
                    manualDateInput.classList.add('hidden');
                    activeDate = new Date(); // Revert to today's date.
                }
                updateDateDisplay(); // Update displayed date.
            });
        });
        
        // Handle manual date input change.
        if(manualDateInput) manualDateInput.addEventListener('change', (e) => {
            const selectedDate = new Date(e.target.value);
            // Adjust for timezone offset to ensure correct date.
            const timezoneOffset = selectedDate.getTimezoneOffset() * 60000; 
            activeDate = new Date(selectedDate.getTime() + timezoneOffset);
            updateDateDisplay(); // Update displayed date.
        });
        
        // Handle theme setting radio button changes.
        themeSettingRadios.forEach(radio => {
            radio.addEventListener('change', (e) => {
                currentTheme = e.target.value;
                applyTheme(currentTheme); // Apply the selected theme.
            });
        });

        // --- INITIALIZATION ---
        // Ensures the app initializes correctly after the DOM is fully loaded.
        setInitialUIState();
    }

    // Check if the DOM is already loaded. If not, wait for DOMContentLoaded.
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeApp);
    } else {
        initializeApp();
    }
    </script>
</body>
</html>
