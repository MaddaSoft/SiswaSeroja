<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Antrian Surat Izin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Expose to global scope for use in the main script
        window.firebaseApp = app;
        window.firebaseAuth = auth;
        window.firebaseDb = db;
        window.initialAuthToken = initialAuthToken;
        window.onAuthStateChanged = onAuthStateChanged;
        window.signInAnonymously = signInAnonymously; 
        window.signOut = signOut;
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        input[type="file"] { display: none; }
        .submenu {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-in-out;
        }
        .submenu.open {
            max-height: 500px; /* Cukup besar untuk menampilkan semua item */
        }
        .menu-item.active {
            background-color: #e0f2fe;
            color: #0c4a6e;
        }
        .menu-item.active svg.arrow {
            transform: rotate(90deg);
        }
        /* Animated Brand */
        .animated-brand {
            background: linear-gradient(90deg, #38bdf8, #3b82f6, #8b5cf6, #ec4899);
            background-size: 200% 200%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: gradient-animation 5s ease infinite;
        }
        @keyframes gradient-animation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        /* Dark Theme */
        .dark, .dark body { background-color: #0f172a; color: #cbd5e1; }
        .dark aside { background-color: #1e293b; border-color: #334155; }
        .dark main { background-color: #0f172a; }
        .dark h1, .dark h2, .dark .font-semibold { color: #f1f5f9; }
        .dark p, .dark label, .dark .text-slate-700 { color: #94a3b8; }
        .dark .menu-item { color: #cbd5e1; }
        .dark .menu-item:hover { background-color: #334155; }
        .dark #submenu-database button, .dark #submenu-database label { color: #94a3b8; }
        .dark #submenu-database button:hover, .dark #submenu-database label:hover { background-color: #334155; }
        .dark #search-form { background-color: #1e293b; border-color: #334155;}
        .dark input, .dark select { background-color: #334155; border-color: #475569; color: #f1f5f9; }
        .dark input::placeholder { color: #64748b; }
        .dark input:disabled { background-color: #334155; opacity: 0.5; }
        .dark #kelas { background-color: #0f172a; }
        .dark #queue-container { background-color: #1e293b; border-color: #334155; }
        .dark #queue-container tr { border-color: #334155; }
        .dark #queue-container thead { background-color: #334155; }
        .dark #queue-container tbody tr { background-color: #1e293b; }
        .dark #queue-container tbody tr:hover { background-color: #334155; }
        .dark .text-slate-800 { color: #f1f5f9; }
        .dark .text-slate-900 { color: #f8fafc; }
        .dark #manual-add-modal > div, .dark #confirm-modal > div, .dark #settings-modal > div, .dark #login-form-modal > div, .dark #employee-management-modal > div, .dark #change-password-modal > div { background-color: #1e293b; }
        /* Public View Specific Styles */
        #public-view {
            background-image: linear-gradient(to right top, #0f172a, #2a0f3a, #4a0f4a, #690f5a, #8b0f6a, #a0207a, #b5308a, #ca409a, #d050a0, #d660a6, #dc70ac, #e280b2); /* Darker, more neon gradient */
            background-size: 200% 200%;
            animation: backgroundPan 15s ease infinite alternate;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 2rem; /* Add some padding to prevent content touching edges */
        }
        @keyframes backgroundPan {
            0% { background-position: 0% 50%; }
            100% { background-position: 100% 50%; }
        }
        .public-content {
            background-color: rgba(20, 20, 30, 0.9); /* Darker translucent background */
            border-radius: 1rem;
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.7), 0 0 30px rgba(0, 255, 255, 0.3); /* Neon glow effect */
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            padding: 4rem; /* Increased padding for full screen content */
            display: flex;
            flex-direction: column;
            justify-content: space-between; /* Push header/footer to ends */
            align-items: center; /* Center content horizontally */
            overflow-y: auto; /* Allow scrolling if content overflows */
        }
        .dark .public-content {
            background-color: rgba(30, 41, 59, 0.9);
            color: #cbd5e1;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .public-header {
            font-size: 3.5rem; /* Larger font size */
            font-weight: 800;
            margin-bottom: 2rem; /* More space */
            background: linear-gradient(45deg, #00ffff, #ff00ff); /* Brighter neon gradient */
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 10px rgba(0, 255, 255, 0.8), 0 0 20px rgba(0, 255, 255, 0.5); /* Text glow */
        }
        .public-description {
            font-size: 1.125rem;
            color: #475569;
            margin-bottom: 2rem;
        }
        .dark .public-description {
            color: #94a3b8;
        }
        .public-info-section {
            text-align: center; /* Center section content */
            margin-top: 2rem;
            border-top: 1px dashed rgba(0, 255, 255, 0.5); /* Dashed glowing border */
            padding-top: 2rem;
            color: #e0f2fe; /* Lighter text color */
        }
        .dark .public-info-section {
            border-color: rgba(0, 255, 255, 0.5);
            color: #e0f2fe;
        }
        .public-info-section h3 {
            font-size: 2rem; /* Larger heading */
            font-weight: 700;
            margin-bottom: 1.5rem; /* More space */
            color: #00ffff; /* Neon cyan */
            text-shadow: 0 0 8px rgba(0, 255, 255, 0.6); /* Text glow */
        }
        .dark .public-info-section h3 {
            color: #00ffff;
        }
        .public-info-section p {
            margin-bottom: 0.75rem;
        }
        .public-queue-table-container {
            border: 1px solid rgba(0, 255, 255, 0.3); /* Subtle glowing border */
            border-radius: 0.5rem;
            margin-top: 1rem;
            background-color: rgba(0, 0, 0, 0.3); /* Darker table background */
        }
        .dark .public-queue-table-container {
            border-color: rgba(0, 255, 255, 0.3);
        }
        .public-queue-table th, .public-queue-table td {
            padding: 0.75rem 1.5rem;
            border-bottom: 1px solid rgba(0, 255, 255, 0.1); /* Subtle border lines */
            color: #e0f2fe; /* Lighter text color for table */
        }
        .dark .public-queue-table th, .dark .public-queue-table td {
            border-color: rgba(0, 255, 255, 0.1);
            color: #e0f2fe;
        }
        .public-queue-table thead {
            background-color: rgba(0, 255, 255, 0.1); /* Lighter translucent header */
            color: #00ffff; /* Neon cyan for header text */
            text-transform: uppercase;
            font-size: 0.85rem; /* Slightly larger font */
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .dark .public-queue-table thead {
            background-color: rgba(0, 255, 255, 0.1);
            color: #00ffff;
        }
        .public-queue-table tbody tr:nth-child(even) {
            background-color: rgba(0, 0, 0, 0.2); /* Slightly different row background */
        }
        .dark .public-queue-table tbody tr:nth-child(even) {
            background-color: rgba(0, 0, 0, 0.2);
        }
        .public-queue-table tbody tr:hover {
            background-color: rgba(0, 255, 255, 0.15); /* Hover glow */
        }
        .dark .public-queue-table tbody tr:hover {
            background-color: rgba(0, 255, 255, 0.15);
        }
        .public-queue-empty-message-row td {
            padding: 1rem;
            text-align: center;
            color: #94a3b8;
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800">

    <!-- Public View (Halaman Informasi Publik) -->
    <div id="public-view" class="fixed inset-0 flex items-center justify-center flex-col p-4 z-50">
        <div class="public-content">
            <header class="mb-8">
                <!-- Removed: <h1 class="public-header">Selamat Datang di Aplikasi Izin Siswa</h1> -->
                <!-- Removed: <p class="public-description">Sistem terpadu untuk pengelolaan izin siswa yang efisien dan transparan.</p> -->
            </header>
            
            <section class="public-info-section mt-6">
                <h3>SISWA IZIN HARI INI : <span id="public-queue-count">0</span> SISWA</h3>
                <div id="public-queue-summary-container" class="public-queue-table-container">
                    <!-- Public queue summary will be rendered here -->
                </div>
            </section>

            <button id="login-button" class="mt-8 px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition-colors shadow-md">
                Masuk ke Dashboard
            </button>
        </div>
    </div>

    <!-- Main Application Dashboard (Hidden by default) -->
    <div id="app-dashboard" class="flex min-h-screen hidden">
        <aside class="w-96 bg-white p-6 border-r border-slate-200 flex flex-col flex-shrink-0 h-screen dark:bg-slate-800 dark:border-slate-700">
            <p class="text-xs font-extrabold tracking-widest uppercase animated-brand mb-4">Madda Soft Production</p>
            <h1 class="text-2xl font-bold mb-1">Aplikasi Izin Siswa</h1>
            <p id="active-date-display" class="text-sm text-slate-500 mb-6">Selasa, 8 Juli 2025</p>
            
            <nav class="space-y-2">
                <!-- Database Siswa menu item, hidden by default -->
                <button id="menu-database" class="menu-item w-full flex items-center justify-between p-3 rounded-lg text-slate-700 hover:bg-slate-100 transition-colors hidden dark:text-slate-300 dark:hover:bg-slate-700">
                    <span class="font-semibold">Database Siswa</span>
                    <svg class="arrow w-4 h-4 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                </button>
                <!-- Database Siswa submenu, hidden by default -->
                <ul id="submenu-database" class="submenu space-y-1 mt-1 pl-4">
                    <li><button id="open-manual-add-modal" class="w-full text-left p-2 rounded-md text-slate-600 hover:bg-slate-100 text-sm flex items-center space-x-2 dark:text-slate-400 dark:hover:bg-slate-700"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg><span>Tambah Siswa Baru</span></button></li>
                    <li>
                        <label for="csv-file-input" class="w-full text-left p-2 rounded-md text-slate-600 hover:bg-slate-100 text-sm block cursor-pointer flex items-center space-x-2 dark:text-slate-400 dark:hover:bg-slate-700"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg><span>Impor dari .XLSX</span></label>
                        <input type="file" id="csv-file-input" accept=".xlsx">
                    </li>
                    <li><button id="download-template-button" class="w-full text-left p-2 rounded-md text-slate-600 hover:bg-slate-100 text-sm flex items-center space-x-2 dark:text-slate-400 dark:hover:bg-slate-700"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg><span>Unduh Template XLSX</span></button></li>
                    <li><button id="delete-database-button" class="w-full text-left p-2 rounded-md text-red-600 hover:bg-red-50 text-sm flex items-center space-x-2 dark:text-red-400 dark:hover:bg-red-900/20"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg><span>Hapus Database</span></button></li>
                </ul>

                <!-- Employee Management Menu Item -->
                <button id="menu-employee-management" class="menu-item w-full flex items-center justify-between p-3 rounded-lg text-slate-700 hover:bg-slate-100 transition-colors hidden dark:text-slate-300 dark:hover:bg-slate-700">
                    <span class="font-semibold">Manajemen Pegawai</span>
                    <svg class="arrow w-4 h-4 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                </button>
                <ul id="submenu-employee-management" class="submenu space-y-1 mt-1 pl-4">
                    <li><button id="open-employee-management-modal" class="w-full text-left p-2 rounded-md text-slate-600 hover:bg-slate-100 text-sm flex items-center space-x-2 dark:text-slate-400 dark:hover:bg-slate-700"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg><span>Kelola Pegawai</span></button></li>
                </ul>

                <!-- Change Password Menu Item -->
                <button id="open-change-password-modal-btn" class="menu-item w-full flex items-center justify-between p-3 rounded-lg text-slate-700 hover:bg-slate-100 transition-colors dark:text-slate-300 dark:hover:bg-slate-700">
                    <span class="font-semibold">Ganti Password</span>
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2v5a2 2 0 01-2 2h-5a2 2 0 01-2-2V9a2 2 0 012-2h5z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9v-2a2 2 0 00-2-2H9a2 2 0 00-2 2v2"></path></svg>
                </button>


                <div class="pt-4">
                    <h2 class="font-semibold text-slate-700 p-3 dark:text-slate-300">Cari & Tambah Antrian</h2>
                    <form id="search-form" class="space-y-3 relative p-3 bg-white rounded-lg shadow-sm dark:bg-slate-800 dark:border-slate-700">
                        <div>
                            <label for="search-nama" class="block text-xs font-medium text-slate-600 dark:text-slate-400">Nama Siswa</label>
                            <input type="text" id="search-nama" name="nama" autocomplete="off" placeholder="Ketik nama..." class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm focus:outline-none focus:border-sky-500 disabled:bg-slate-50 dark:bg-slate-700 dark:border-slate-600 dark:text-slate-100 dark:disabled:bg-slate-700/50">
                            <div id="autocomplete-results" class="absolute z-10 w-full bg-white border border-slate-200 rounded-md mt-1 max-h-48 overflow-y-auto shadow-lg hidden dark:bg-slate-700 dark:border-slate-600"></div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="kelas" class="block text-xs font-medium text-slate-600 dark:text-slate-400">Kelas</label>
                                <input type="text" id="kelas" name="kelas" readonly class="mt-1 block w-full px-3 py-2 bg-slate-100 border-slate-300 rounded-md text-sm dark:bg-slate-900 dark:border-slate-700 dark:text-slate-300">
                            </div>
                             <div>
                                <label for="wali" class="block text-xs font-medium text-slate-600 dark:text-slate-400">Nama Orang Tua / Wali</label>
                                <input type="text" id="wali" name="wali" required placeholder="Nama Wali" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm focus:outline-none focus:border-sky-500 dark:bg-slate-700 dark:border-slate-600 dark:text-slate-100">
                            </div>
                        </div>
                        <div>
                            <label for="keterangan" class="block text-xs font-medium text-slate-600 dark:text-slate-400">Keterangan</label>
                            <div class="flex items-center space-x-2 mt-1">
                                <select id="keterangan" name="keterangan" class="block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm focus:outline-none focus:border-sky-500 dark:bg-slate-700 dark:border-slate-600 dark:text-slate-100">
                                    <option>Sakit</option>
                                    <option>Izin</option>
                                </select>
                                <button type="submit" id="add-button" class="px-4 py-2 bg-indigo-600 text-white font-semibold rounded-md hover:bg-indigo-700 disabled:bg-indigo-300 whitespace-nowrap dark:disabled:bg-indigo-900/50">
                                    + Tambah
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </nav>
            
            <div class="mt-auto flex justify-between items-center text-xs text-slate-400 pt-4 border-t dark:border-slate-700">
                <span id="database-info">Database kosong.</span>
                <span id="user-id-display" class="text-xs text-slate-400"></span>
                <button id="open-settings-modal" class="p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-700">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                </button>
                <button id="logout-button" class="px-3 py-1 bg-red-500 text-white text-xs rounded-md hover:bg-red-600 transition-colors ml-2">Keluar</button>
            </div>
        </aside>

        <main class="flex-grow bg-slate-50 p-8 flex flex-col h-screen dark:bg-slate-900">
             <div class="flex justify-between items-center mb-4">
                <h2 id="queue-title" class="text-xl font-semibold dark:text-slate-100">Daftar Antrian</h2>
                <div class="flex items-center space-x-4">
                    <!-- Reset Queue Button, hidden by default -->
                    <button id="reset-queue-button" class="text-sm text-orange-600 hover:text-orange-800 font-semibold hidden dark:text-orange-400 dark:hover:text-orange-500">Hapus Data Hari Ini</button>
                    <!-- Print PDF Button, hidden by default -->
                    <button id="print-pdf-button" class="bg-blue-600 text-white font-bold py-2 px-5 rounded-md hover:bg-blue-700 text-sm hidden">Cetak Laporan</button>
                    <button id="print-slips-button" class="bg-emerald-600 text-white font-bold py-2 px-5 rounded-md hover:bg-emerald-700 text-sm">Cetak Izin Siswa</button>
                </div>
            </div>
            <div id="queue-container" class="flex-grow overflow-y-auto bg-white rounded-lg border border-slate-200 shadow-sm dark:bg-slate-800 dark:border-slate-700">
                </div>
            <footer class="text-center text-xs text-slate-400 pt-4 dark:text-slate-500">
                Design & Creative 2025 By : Madda soft Feat Gemini
            </footer>
        </main>
    </div>

    <!-- Manual Add Student Modal -->
    <div id="manual-add-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-md dark:bg-slate-800">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold dark:text-slate-100">Tambah Siswa Baru ke Database</h2>
                <button id="close-manual-add-modal-button" class="text-slate-500 hover:text-slate-800 dark:text-slate-400 dark:hover:text-slate-200">&times;</button>
            </div>
            <form id="manual-add-form" class="space-y-4">
                    <p class="text-sm text-slate-600 dark:text-slate-400">Siswa yang ditambahkan di sini akan langsung bisa dicari.</p>
                    <div>
                        <label for="manual-nama" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Nama Siswa Baru</label>
                        <input type="text" id="manual-nama" placeholder="Nama Lengkap" required class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm dark:bg-slate-700 dark:border-slate-600 dark:text-slate-100">
                    </div>
                    <div>
                        <label for="manual-kelas" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Kelas</label>
                        <input type="text" id="manual-kelas" placeholder="Contoh: 9A" required class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm dark:bg-slate-700 dark:border-slate-600 dark:text-slate-100">
                    </div>
                    <button type="submit" class="w-full bg-green-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-green-700">Tambah ke Database</button>
            </form>
        </div>
    </div>

    <!-- Confirmation / Message Modal (Reused) -->
    <div id="confirm-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm dark:bg-slate-800">
            <h3 id="confirm-title" class="text-lg font-bold dark:text-slate-100">Konfirmasi Aksi</h3>
            <p id="confirm-message" class="text-sm text-slate-600 mb-6 dark:text-slate-400">Apakah Anda yakin?</p>
            <div class="flex justify-end space-x-3">
                <button id="confirm-cancel-btn" class="px-4 py-2 rounded-md text-sm font-medium bg-slate-100 hover:bg-slate-200 dark:bg-slate-700 dark:hover:bg-slate-600 dark:text-slate-300">Batal</button>
                <button id="confirm-ok-btn" class="px-4 py-2 rounded-md text-sm font-medium text-white bg-red-600 hover:bg-red-700">Ya, Lanjutkan</button>
            </div>
        </div>
    </div>
    
    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-md dark:bg-slate-800">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold dark:text-slate-100">Pengaturan</h2>
                <button id="close-settings-modal-button" class="text-slate-500 hover:text-slate-800 dark:text-slate-400 dark:hover:text-slate-200">&times;</button>
            </div>
            <div class="space-y-6">
                <div>
                    <h3 class="font-semibold mb-2 dark:text-slate-200">Pengaturan Tanggal Laporan</h3>
                    <div class="flex items-center space-x-4">
                        <label class="flex items-center space-x-2 dark:text-slate-300">
                            <input type="radio" name="date-setting" value="auto" checked>
                            <span>Otomatis (Hari Ini)</span>
                        </label>
                        <label class="flex items-center space-x-2 dark:text-slate-300">
                            <input type="radio" name="date-setting" value="manual">
                            <span>Manual</span>
                        </label>
                    </div>
                    <input type="date" id="manual-date-input" class="mt-2 w-full p-2 border rounded-md hidden dark:bg-slate-700 dark:border-slate-600 dark:text-slate-100">
                </div>
                <div>
                    <h3 class="font-semibold mb-2 dark:text-slate-200">Tema Tampilan</h3>
                     <div class="flex items-center space-x-4">
                        <label class="flex items-center space-x-2 dark:text-slate-300">
                            <input type="radio" name="theme-setting" value="light" checked>
                            <span>Cerah</span>
                        </label>
                        <label class="flex items-center space-x-2 dark:text-slate-300">
                            <input type="radio" name="theme-setting" value="dark">
                            <span>Gelap</span>
                        </label>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Login Form Modal -->
    <div id="login-form-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm dark:bg-slate-800">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold dark:text-slate-100">Masuk ke Dashboard</h2>
                <button id="close-login-modal-button" class="text-slate-500 hover:text-slate-800 dark:text-slate-400 dark:hover:text-slate-200">&times;</button>
            </div>
            <form id="login-form" class="space-y-4">
                <div>
                    <label for="login-username" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Username / NIP</label>
                    <input type="text" id="login-username" placeholder="Masukkan Username atau NIP" required class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm focus:outline-none focus:border-sky-500 dark:bg-slate-700 dark:border-slate-600 dark:text-slate-100">
                </div>
                <div>
                    <label for="login-password" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Password</label>
                    <input type="password" id="login-password" placeholder="Password Anda" required class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm focus:outline-none focus:border-sky-500 dark:bg-slate-700 dark:border-slate-600 dark:text-slate-100">
                </div>
                <button type="submit" class="w-full bg-indigo-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-indigo-700">Masuk</button>
            </form>
        </div>
    </div>

    <!-- Employee Management Modal -->
    <div id="employee-management-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-3xl dark:bg-slate-800">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold dark:text-slate-100">Manajemen Pegawai</h2>
                <button id="close-employee-management-modal-button" class="text-slate-500 hover:text-slate-800 dark:text-slate-400 dark:hover:text-slate-200">&times;</button>
            </div>
            
            <!-- Add New Employee Form -->
            <h3 class="text-lg font-semibold mb-3 dark:text-slate-200">Tambah Pegawai Baru</h3>
            <form id="add-employee-form" class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6 p-4 border border-slate-200 rounded-lg dark:border-slate-700">
                <div>
                    <label for="new-employee-username" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Username</label>
                    <input type="text" id="new-employee-username" required class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm dark:bg-slate-700 dark:border-slate-600 dark:text-slate-100">
                </div>
                <div>
                    <label for="new-employee-password" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Password</label>
                    <input type="password" id="new-employee-password" required class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm dark:bg-slate-700 dark:border-slate-600 dark:text-slate-100">
                </div>
                <div>
                    <label for="new-employee-name" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Nama Lengkap</label>
                    <input type="text" id="new-employee-name" required class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm dark:bg-slate-700 dark:border-slate-600 dark:text-slate-100">
                </div>
                <div>
                    <label for="new-employee-role" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Peran</label>
                    <select id="new-employee-role" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm dark:bg-slate-700 dark:border-slate-600 dark:text-slate-100">
                        <option value="staff">Staf (Guru/TU)</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
                <div class="col-span-full text-right">
                    <button type="submit" class="px-4 py-2 bg-green-600 text-white font-semibold rounded-md hover:bg-green-700">Tambah Pegawai</button>
                </div>
            </form>

            <!-- Employee List Table -->
            <h3 class="text-lg font-semibold mb-3 dark:text-slate-200">Daftar Pegawai</h3>
            <div class="overflow-x-auto border border-slate-200 rounded-lg shadow-sm dark:border-slate-700">
                <table class="w-full text-sm text-left text-slate-500">
                    <thead class="text-xs text-slate-700 uppercase bg-slate-100 dark:bg-slate-700 dark:text-slate-300">
                        <tr>
                            <th scope="col" class="px-6 py-3">Username</th>
                            <th scope="col" class="px-6 py-3">Nama Lengkap</th>
                            <th scope="col" class="px-6 py-3">Peran</th>
                            <th scope="col" class="px-6 py-3 text-center">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="employee-table-body">
                        <!-- Employee rows will be inserted here by JavaScript -->
                    </tbody>
                </table>
                <div id="no-employees-message" class="p-4 text-center text-slate-400 hidden">Tidak ada pegawai di database.</div>
            </div>
        </div>
    </div>

    <!-- Change Password Modal -->
    <div id="change-password-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-md dark:bg-slate-800">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold dark:text-slate-100">Ganti Password</h2>
                <button id="close-change-password-modal-button" class="text-slate-500 hover:text-slate-800 dark:text-slate-400 dark:hover:text-slate-200">&times;</button>
            </div>
            <form id="change-password-form" class="space-y-4">
                <div>
                    <label for="current-password" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Password Saat Ini</label>
                    <input type="password" id="current-password" required class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm focus:outline-none focus:border-sky-500 dark:bg-slate-700 dark:border-slate-600 dark:text-slate-100">
                </div>
                <div>
                    <label for="new-password" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Password Baru</label>
                    <input type="password" id="new-password" required class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm focus:outline-none focus:border-sky-500 dark:bg-slate-700 dark:border-slate-600 dark:text-slate-100">
                </div>
                <div>
                    <label for="confirm-new-password" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Konfirmasi Password Baru</label>
                    <input type="password" id="confirm-new-password" required class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm focus:outline-none focus:border-sky-500 dark:bg-slate-700 dark:border-slate-600 dark:text-slate-100">
                </div>
                <button type="submit" class="w-full bg-indigo-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-indigo-700">Ganti Password</button>
            </form>
        </div>
    </div>

    <script>
    // Ensure Firebase modules are loaded before initializing the app logic
    document.addEventListener('DOMContentLoaded', () => {
        // Wait for Firebase global variables to be available
        const checkFirebaseReady = setInterval(() => {
            if (window.firebaseAuth && window.firebaseDb && window.signInAnonymously) {
                clearInterval(checkFirebaseReady);
                initializeApp();
            }
        }, 100); // Check every 100ms
    });

    function initializeApp() {
        // --- FIREBASE INITIALIZATION ---
        const auth = window.firebaseAuth;
        const db = window.firebaseDb;
        const onAuthStateChanged = window.onAuthStateChanged;
        const signInAnonymously = window.signInAnonymously; // Used for internal Firebase auth state
        const signOut = window.signOut;

        let userId = null; // To store the current user's ID (Firebase anonymous UID)
        let loggedInEmployee = null; // To store the details of the logged-in employee

        // --- EMPLOYEE DATABASE (FOR DEMONSTRATION ONLY) ---
        // For a production application, this data should be stored securely in a database
        // like Firestore, and authentication should be handled by a backend service.
        // Initial hardcoded employees for first run if localStorage is empty
        let employees = [
            { username: 'admin', password: 'password123', name: 'Admin Utama', role: 'admin' },
            { username: 'guru1', password: 'passguru', name: 'Bapak Budi', role: 'staff' },
            { username: 'tu', password: 'passtu', name: 'Ibu Siti', role: 'staff' }
        ];

        // --- STATE MANAGEMENT ---
        let studentDatabase = [];
        let printQueue = []; // This will now persist for public view
        let selectedStudent = null;
        let onConfirmCallback = null;
        let activeDate = new Date();
        let dateMode = 'auto';
        let currentTheme = localStorage.getItem('appTheme') || 'light';

        // NEW: Variables for public queue carousel
        let publicCurrentPage = 0;
        const publicItemsPerPage = 10;
        let publicQueueInterval = null;

        // --- DOM ELEMENTS ---
        const publicView = document.getElementById('public-view');
        const appDashboard = document.getElementById('app-dashboard');
        const loginButton = document.getElementById('login-button');
        const logoutButton = document.getElementById('logout-button');
        const userIdDisplay = document.getElementById('user-id-display'); // Now displays employee name/username

        const appTitle = document.querySelector('h1');
        const appVersion = document.querySelector('p.text-sm.text-slate-500');
        const activeDateDisplay = document.getElementById('active-date-display');
        const menuDatabase = document.getElementById('menu-database');
        const submenuDatabase = document.getElementById('submenu-database');
        const fileInput = document.getElementById('csv-file-input');
        const downloadTemplateButton = document.getElementById('download-template-button');
        const deleteDatabaseButton = document.getElementById('delete-database-button');
        const databaseInfo = document.getElementById('database-info');
        const searchForm = document.getElementById('search-form');
        const searchInput = document.getElementById('search-nama');
        const classInput = document.getElementById('kelas');
        const waliInput = document.getElementById('wali');
        const reasonSelect = document.getElementById('keterangan');
        const addButton = document.getElementById('add-button');
        const autocompleteResults = document.getElementById('autocomplete-results');
        const queueTitle = document.getElementById('queue-title');
        const queueContainer = document.getElementById('queue-container');
        const resetQueueButton = document.getElementById('reset-queue-button');
        const printPdfButton = document.getElementById('print-pdf-button');
        const printSlipsButton = document.getElementById('print-slips-button');
        
        const manualAddForm = document.getElementById('manual-add-form');
        const openManualAddModalBtn = document.getElementById('open-manual-add-modal');
        const manualAddModal = document.getElementById('manual-add-modal');
        const closeModalBtn = document.getElementById('close-manual-add-modal-button');

        const confirmModal = document.getElementById('confirm-modal');
        const confirmTitle = document.getElementById('confirm-title');
        const confirmMessage = document.getElementById('confirm-message');
        const confirmOkBtn = document.getElementById('confirm-ok-btn');
        const confirmCancelBtn = document.getElementById('confirm-cancel-btn');

        const openSettingsModalBtn = document.getElementById('open-settings-modal');
        const settingsModal = document.getElementById('settings-modal');
        const closeSettingsModalBtn = document.getElementById('close-settings-modal-button');
        const dateSettingRadios = document.querySelectorAll('input[name="date-setting"]');
        const manualDateInput = document.getElementById('manual-date-input');
        const themeSettingRadios = document.querySelectorAll('input[name="theme-setting"]');

        // Login Form Modal Elements
        const loginFormModal = document.getElementById('login-form-modal');
        const closeLoginFormModalBtn = document.getElementById('close-login-modal-button');
        const loginForm = document.getElementById('login-form');
        const loginUsernameInput = document.getElementById('login-username');
        const loginPasswordInput = document.getElementById('login-password');

        // Employee Management Modal Elements
        const menuEmployeeManagement = document.getElementById('menu-employee-management');
        const submenuEmployeeManagement = document.getElementById('submenu-employee-management');
        const openEmployeeManagementModalBtn = document.getElementById('open-employee-management-modal');
        const employeeManagementModal = document.getElementById('employee-management-modal');
        const closeEmployeeManagementModalBtn = document.getElementById('close-employee-management-modal-button');
        const addEmployeeForm = document.getElementById('add-employee-form');
        const newEmployeeUsernameInput = document.getElementById('new-employee-username');
        const newEmployeePasswordInput = document.getElementById('new-employee-password');
        const newEmployeeNameInput = document.getElementById('new-employee-name');
        const newEmployeeRoleSelect = document.getElementById('new-employee-role');
        const employeeTableBody = document.getElementById('employee-table-body');
        const noEmployeesMessage = document.getElementById('no-employees-message');

        // Public View Specific Elements
        const publicQueueCount = document.getElementById('public-queue-count');
        const publicQueueSummaryContainer = document.getElementById('public-queue-summary-container');

        // Change Password Modal Elements
        const openChangePasswordModalBtn = document.getElementById('open-change-password-modal-btn');
        const changePasswordModal = document.getElementById('change-password-modal');
        const closeChangePasswordModalBtn = document.getElementById('close-change-password-modal-button');
        const changePasswordForm = document.getElementById('change-password-form');
        const currentPasswordInput = document.getElementById('current-password');
        const newPasswordInput = document.getElementById('new-password');
        const confirmNewPasswordInput = document.getElementById('confirm-new-password');
        
        // --- AUTHENTICATION LOGIC ---
        onAuthStateChanged(auth, (user) => {
            if (user && loggedInEmployee) { // Check if Firebase is authenticated AND an employee is logged in
                userId = user.uid; // Firebase anonymous UID
                publicView.classList.add('hidden');
                appDashboard.classList.remove('hidden');
                if (userIdDisplay) userIdDisplay.textContent = `Login sebagai: ${loggedInEmployee.name}`;
                
                // Load student database (private to logged-in users)
                loadStudentDatabaseFromLocalStorage(); 

                // Stop public carousel when logged in
                if (publicQueueInterval) {
                    clearInterval(publicQueueInterval);
                    publicQueueInterval = null;
                }

                // Show/hide employee management menu based on role
                if (loggedInEmployee.role === 'admin') {
                    menuEmployeeManagement.classList.remove('hidden');
                    menuDatabase.classList.remove('hidden'); // Show Database menu for admin
                    resetQueueButton.classList.remove('hidden'); // Show Reset Queue button for admin
                    printPdfButton.classList.remove('hidden'); // Show Print PDF button for admin
                } else {
                    menuEmployeeManagement.classList.add('hidden');
                    submenuEmployeeManagement.classList.remove('open'); // Close submenu if not admin
                    menuDatabase.classList.add('hidden'); // Hide Database menu for non-admin
                    submenuDatabase.classList.remove('open'); // Close submenu if not admin
                    resetQueueButton.classList.add('hidden'); // Hide Reset Queue button for non-admin
                    printPdfButton.classList.add('hidden'); // Hide Print PDF button for non-admin
                }
                // Change Password menu is always visible for logged-in users
                openChangePasswordModalBtn.classList.remove('hidden');

            } else {
                userId = null;
                loggedInEmployee = null; // Clear logged-in employee state
                publicView.classList.remove('hidden');
                appDashboard.classList.add('hidden');
                if (userIdDisplay) userIdDisplay.textContent = '';
                // Clear student database from memory on logout (printQueue persists)
                studentDatabase = []; 
                saveStudentDatabaseToLocalStorage(); // Save empty student database
                updateDatabaseInfo();
                
                // Re-render public queue summary and start carousel when logged out
                renderPublicQueueSummary(); 
                startPublicQueueCarousel(); // Start carousel when logged out

                menuEmployeeManagement.classList.add('hidden'); // Always hide for logged out users
                submenuEmployeeManagement.classList.remove('open');
                menuDatabase.classList.add('hidden'); // Always hide for logged out users
                submenuDatabase.classList.remove('open');
                resetQueueButton.classList.add('hidden'); // Always hide for logged out users
                printPdfButton.classList.add('hidden'); // Always hide for logged out users
                openChangePasswordModalBtn.classList.add('hidden'); // Hide change password for logged out users
            }
        });

        // Function to handle login with username and password (custom authentication)
        async function handleEmployeeLogin(event) {
            event.preventDefault(); // Prevent default form submission
            const username = loginUsernameInput.value.trim();
            const password = loginPasswordInput.value.trim();

            if (!username || !password) {
                showMessage('Login Gagal', 'Username/NIP dan password tidak boleh kosong.');
                return;
            }

            // Find employee in the hardcoded list
            const foundEmployee = employees.find(emp => 
                emp.username.toLowerCase() === username.toLowerCase() && emp.password === password
            );

            if (foundEmployee) {
                loggedInEmployee = foundEmployee; // Store logged-in employee details
                try {
                    // Sign in anonymously to get a Firebase UID for session management
                    await signInAnonymously(auth); 
                    loginFormModal.classList.add('hidden'); // Hide login modal on success
                    loginForm.reset(); // Clear form fields after successful login
                    // onAuthStateChanged listener will handle UI update based on Firebase auth and loggedInEmployee state
                } catch (error) {
                    console.error("Firebase anonymous sign-in failed:", error);
                    showMessage('Login Gagal', `Terjadi kesalahan saat memulai sesi: ${error.message}`);
                    loggedInEmployee = null; // Reset if Firebase auth fails
                }
            } else {
                showMessage('Login Gagal', 'Username/NIP atau password salah. Silakan coba lagi.');
            }
        }

        async function handleLogout() {
            try {
                await signOut(auth); // Sign out from Firebase
                // loggedInEmployee is cleared by onAuthStateChanged listener
                showMessage('Berhasil Keluar', 'Anda telah berhasil keluar dari aplikasi.');
                // onAuthStateChanged listener will handle UI update
            } catch (error) {
                console.error("Logout failed:", error);
                showMessage('Logout Gagal', `Terjadi kesalahan saat keluar: ${error.message}`);
            }
        }

        // NEW: Function to advance public queue page
        function advancePublicQueuePage() {
            if (printQueue.length <= publicItemsPerPage) {
                publicCurrentPage = 0; // Reset if less than or equal to one page
                // Do not clear interval here, let it continue if there's only one page to display.
                // It will just keep rendering the same page.
                return;
            }
            const totalPages = Math.ceil(printQueue.length / publicItemsPerPage);
            publicCurrentPage = (publicCurrentPage + 1) % totalPages;
            renderPublicQueueSummary();
        }

        // NEW: Function to start public queue carousel
        function startPublicQueueCarousel() {
            if (publicQueueInterval) {
                clearInterval(publicQueueInterval); // Clear any existing interval
            }
            // Start carousel only if there's more than one page of data
            if (printQueue.length > publicItemsPerPage) {
                publicQueueInterval = setInterval(advancePublicQueuePage, 5000); // Rotate every 5 seconds
            }
        }

        // --- INITIAL UI STATE ---
        function setInitialUIState() {
            if (appTitle) appTitle.textContent = "Aplikasi Izin Siswa";
            if (appVersion) appVersion.textContent = "Versi 2.1 (XLSX Support)";
            if (searchInput) searchInput.disabled = true;
            if (addButton) addButton.disabled = true;
            
            applyTheme(currentTheme);
            updateDateDisplay();
            loadEmployeesFromLocalStorage(); // Load employees at startup
            loadPrintQueueFromLocalStorage(); // Load printQueue for public view at startup

            // Ensure these are hidden on initial load before auth state is determined
            menuDatabase.classList.add('hidden');
            submenuDatabase.classList.remove('open'); // Ensure submenu is closed
            menuEmployeeManagement.classList.add('hidden');
            submenuEmployeeManagement.classList.remove('open'); // Ensure submenu is closed
            resetQueueButton.classList.add('hidden');
            printPdfButton.classList.add('hidden');
            openChangePasswordModalBtn.classList.add('hidden'); // Hidden by default

            simulateInitialData(); // Call simulation after loading existing data
            renderPublicQueueSummary(); // Render public queue on initial load
            startPublicQueueCarousel(); // Start carousel on initial load (if applicable)
        }

        // --- RENDER FUNCTIONS ---
        function renderQueue() {
            if (!queueContainer || !queueTitle) return;
            queueContainer.innerHTML = '';
            queueTitle.textContent = `Daftar Antrian (${printQueue.length} Siswa)`;

            if (printQueue.length === 0) {
                queueContainer.innerHTML = `<div class="h-full flex items-center justify-center"><p class="text-base text-slate-400">Antrian kosong.</p></div>`;
                return;
            }
            
            const table = document.createElement('table');
            table.className = 'w-full text-sm text-left text-slate-500';
            table.innerHTML = `
                <thead class="text-xs text-slate-700 uppercase bg-slate-100 sticky top-0 dark:bg-slate-700 dark:text-slate-300">
                    <tr>
                        <th scope="col" class="px-6 py-3 w-12">No</th>
                        <th scope="col" class="px-6 py-3">Nama Siswa</th>
                        <th scope="col" class="px-6 py-3">Kelas</th>
                        <th scope="col" class="px-6 py-3">Orang Tua/Wali</th>
                        <th scope="col" class="px-6 py-3">Keterangan</th>
                        <th scope="col" class="px-6 py-3">Ditambahkan Oleh</th> <!-- NEW COLUMN HEADER -->
                        <th scope="col" class="px-6 py-3 text-center">Aksi</th>
                    </tr>
                </thead>
                <tbody id="queue-table-body"></tbody>
            `;
            
            const tableBody = table.querySelector('#queue-table-body');
            printQueue.forEach((student, index) => {
                const row = document.createElement('tr');
                row.className = 'bg-white border-b hover:bg-slate-50 dark:bg-slate-800 dark:border-slate-700 dark:hover:bg-slate-700';
                
                // Determine if the delete button should be enabled
                let isDeleteEnabled = false;
                if (loggedInEmployee && loggedInEmployee.role === 'admin') {
                    isDeleteEnabled = true; // Admin can always delete
                } else if (loggedInEmployee && student.addedByUsername === loggedInEmployee.username) {
                    isDeleteEnabled = true; // User can delete their own entry
                }

                row.innerHTML = `
                    <td class="px-6 py-4 font-medium text-slate-900 dark:text-slate-100">${index + 1}</td>
                    <td class="px-6 py-4 font-semibold text-slate-800 dark:text-slate-200">${student.name}</td>
                    <td class="px-6 py-4">${student.class}</td>
                    <td class="px-6 py-4">${student.wali}</td>
                    <td class="px-6 py-4"><span class="font-medium text-amber-600">${student.reason}</span></td>
                    <td class="px-6 py-4">${student.addedBy || '-'}</td> <!-- Display who added it -->
                    <td class="px-6 py-4 text-center">
                        <button data-index="${index}" 
                                data-added-by-username="${student.addedByUsername || ''}" 
                                class="remove-queue-btn text-red-500 hover:text-red-700 font-semibold ${isDeleteEnabled ? '' : 'opacity-50 cursor-not-allowed'}" 
                                ${isDeleteEnabled ? '' : 'disabled'}>Hapus</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            
            queueContainer.appendChild(table);
            renderPublicQueueSummary(); // Update public view when queue changes
        }

        // NEW: Renders the public summary of today's queue with pagination/carousel
        function renderPublicQueueSummary() {
            if (!publicQueueSummaryContainer || !publicQueueCount) return;

            publicQueueCount.textContent = printQueue.length;
            publicQueueSummaryContainer.innerHTML = ''; // Clear existing content

            const table = document.createElement('table');
            table.className = 'w-full text-sm text-left text-slate-500 public-queue-table';
            table.innerHTML = `
                <thead>
                    <tr>
                        <th scope="col" class="px-6 py-3">No</th>
                        <th scope="col" class="px-6 py-3">Nama Siswa</th>
                        <th scope="col" class="px-6 py-3">Kelas</th>
                        <th scope="col" class="px-6 py-3">Keterangan</th>
                    </tr>
                </thead>
                <tbody></tbody>
            `;
            const tableBody = table.querySelector('tbody');

            if (printQueue.length === 0) {
                const emptyRow = document.createElement('tr');
                emptyRow.className = 'public-queue-empty-message-row';
                emptyRow.innerHTML = `<td colspan="4" class="px-6 py-4">Belum ada siswa dalam antrian izin hari ini.</td>`;
                tableBody.appendChild(emptyRow);
            } else {
                // Calculate start and end index for current page
                const totalPages = Math.ceil(printQueue.length / publicItemsPerPage);
                const startIndex = publicCurrentPage * publicItemsPerPage;
                const endIndex = Math.min(startIndex + publicItemsPerPage, printQueue.length);
                
                const studentsToDisplay = printQueue.slice(startIndex, endIndex);

                studentsToDisplay.forEach((student, index) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="px-6 py-4">${startIndex + index + 1}</td>
                        <td class="px-6 py-4 font-semibold">${student.name}</td>
                        <td class="px-6 py-4">${student.class}</td>
                        <td class="px-6 py-4">${student.reason}</td>
                    `;
                    tableBody.appendChild(row);
                });
            }
            publicQueueSummaryContainer.appendChild(table);
        }

        // Renders the employee list table in the employee management modal
        function renderEmployeesTable() {
            if (!employeeTableBody || !noEmployeesMessage) return;

            employeeTableBody.innerHTML = ''; // Clear existing rows

            if (employees.length === 0) {
                noEmployeesMessage.classList.remove('hidden');
                return;
            } else {
                noEmployeesMessage.classList.add('hidden');
            }

            employees.forEach((emp, index) => {
                const row = document.createElement('tr');
                row.className = 'bg-white border-b hover:bg-slate-50 dark:bg-slate-800 dark:border-slate-700 dark:hover:bg-slate-700';
                row.innerHTML = `
                    <td class="px-6 py-4 font-medium text-slate-900 dark:text-slate-100">${emp.username}</td>
                    <td class="px-6 py-4">${emp.name}</td>
                    <td class="px-6 py-4">${emp.role === 'admin' ? 'Admin' : 'Staf'}</td>
                    <td class="px-6 py-4 text-center">
                        <button data-username="${emp.username}" class="delete-employee-btn text-red-500 hover:text-red-700 font-semibold">Hapus</button>
                    </td>
                `;
                employeeTableBody.appendChild(row);
            });
        }
        
        // --- MODAL & NOTIFICATION LOGIC ---
        function showCustomModal(type, title, message, onConfirm = null) {
            if (!confirmModal || !confirmTitle || !confirmMessage || !confirmOkBtn || !confirmCancelBtn) return;

            confirmTitle.textContent = title;
            confirmMessage.textContent = message;
            onConfirmCallback = onConfirm;

            if (type === 'message') {
                confirmOkBtn.textContent = 'OK';
                confirmOkBtn.className = 'px-4 py-2 rounded-md text-sm font-medium text-white bg-blue-600 hover:bg-blue-700';
                confirmCancelBtn.classList.add('hidden');
            } else {
                confirmOkBtn.textContent = 'Ya, Lanjutkan';
                confirmOkBtn.className = 'px-4 py-2 rounded-md text-sm font-medium text-white bg-red-600 hover:bg-red-700';
                confirmCancelBtn.classList.remove('hidden');
            }

            confirmModal.classList.remove('hidden');
            confirmModal.classList.add('flex');
        }

        function showMessage(title, message) {
            showCustomModal('message', title, message);
        }

        function showConfirmation(title, message, onConfirm) {
            showCustomModal('confirm', title, message, onConfirm);
        }

        function hideConfirmation() {
            if (!confirmModal) return;
            confirmModal.classList.add('hidden');
            confirmModal.classList.remove('flex');
            onConfirmCallback = null;
        }

        // --- DATA PERSISTENCE (localStorage) ---
        // Save student database (private to logged-in users)
        function saveStudentDatabaseToLocalStorage() {
            localStorage.setItem('studentDatabase', JSON.stringify(studentDatabase));
            console.log("Student database saved to localStorage.");
        }

        // Load student database (private to logged-in users)
        function loadStudentDatabaseFromLocalStorage() {
            const storedStudents = localStorage.getItem('studentDatabase');
            if (storedStudents) {
                try {
                    studentDatabase = JSON.parse(storedStudents);
                    updateDatabaseInfo();
                }
                catch (e) {
                    console.error("Error parsing studentDatabase from localStorage", e);
                    studentDatabase = [];
                    showMessage('Error', 'Gagal memuat database siswa dari penyimpanan lokal. Data mungkin rusak.');
                }
            }
        }

        // Save print queue (public data)
        function savePrintQueueToLocalStorage() {
            localStorage.setItem('printQueue', JSON.stringify(printQueue));
            console.log("Print queue saved to localStorage.");
        }

        // Load print queue (public data)
        function loadPrintQueueFromLocalStorage() {
            const storedQueue = localStorage.getItem('printQueue');
            if (storedQueue) {
                try {
                    printQueue = JSON.parse(storedQueue);
                }
                catch (e) {
                    console.error("Error parsing printQueue from localStorage", e);
                    printQueue = [];
                    showMessage('Error', 'Gagal memuat antrian izin dari penyimpanan lokal. Data mungkin rusak.');
                }
            }
            renderQueue(); // Always render main queue on load (even if empty)
        }

        // Save employees to localStorage
        function saveEmployeesToLocalStorage() {
            localStorage.setItem('employees', JSON.stringify(employees));
            console.log("Employee data saved to localStorage.");
        }

        // Load employees from localStorage
        function loadEmployeesFromLocalStorage() {
            const storedEmployees = localStorage.getItem('employees');
            if (storedEmployees) {
                try {
                    employees = JSON.parse(storedEmployees);
                } catch (e) {
                    console.error("Error parsing employees from localStorage", e);
                    // If parsing fails, revert to hardcoded default employees
                    employees = [
                        { username: 'admin', password: 'password123', name: 'Admin Utama', role: 'admin' },
                        { username: 'guru1', password: 'passguru', name: 'Bapak Budi', role: 'staff' },
                        { username: 'tu', password: 'passtu', name: 'Ibu Siti', role: 'staff' }
                    ];
                    showMessage('Peringatan', 'Gagal memuat data pegawai dari penyimpanan lokal. Menggunakan data default.');
                }
            }
            // If no stored employees, the 'employees' array remains its hardcoded default
        }

        // --- CORE LOGIC ---
        // NEW: Function to simulate initial student and queue data
        function simulateInitialData() {
            // Only simulate if the student database is empty to avoid overwriting user data
            // Check localStorage directly for existing data
            const existingStudents = localStorage.getItem('studentDatabase');
            const existingQueue = localStorage.getItem('printQueue');

            if (existingStudents && JSON.parse(existingStudents).length > 0 || 
                existingQueue && JSON.parse(existingQueue).length > 0) {
                console.log("Data already exists, skipping simulation.");
                return;
            }

            console.log("Simulating initial data...");

            const sampleNames = [
                "Budi Santoso", "Siti Aminah", "Joko Susilo", "Dewi Lestari", "Agus Salim",
                "Fitriani Hasan", "Rina Amelia", "Doni Saputra", "Eka Putri", "Fajar Ramadhan",
                "Gita Permata", "Hadi Wijaya", "Indah Sari", "Kevin Pratama", "Lia Anggraini",
                "Mira Yulianti", "Nanda Pratama", "Oscar Wijaya", "Putri Rahayu", "Qori Abdullah"
            ];
            const sampleClasses = ["10A", "10B", "11IPA1", "11IPS2", "12IPA3", "12IPS4"];
            const sampleWalis = [
                "Bapak Budi", "Ibu Aminah", "Pak Susilo", "Bu Lestari", "Pak Salim",
                "Bu Hasan", "Ibu Rina", "Pak Doni", "Bu Eka", "Pak Fajar"
            ];
            const sampleReasons = ["Sakit", "Izin"];

            // Generate 20 unique students for the database
            for (let i = 0; i < 20; i++) {
                const name = sampleNames[i % sampleNames.length] + (i < 10 ? '' : ` ${i + 1}`); // Add number for more uniqueness
                const studentClass = sampleClasses[i % sampleClasses.length];
                const wali = sampleWalis[i % sampleWalis.length];
                const nomorHpWali = `0812345${1000 + i}`;
                studentDatabase.push({ name, class: studentClass, wali, nomorHpWali });
            }

            // Select some students for the initial print queue
            const queueStudentsCount = 15; // More than 10 to test pagination
            const shuffledStudents = [...studentDatabase].sort(() => 0.5 - Math.random()); // Shuffle for variety

            for (let i = 0; i < queueStudentsCount; i++) {
                const student = shuffledStudents[i];
                const reason = sampleReasons[i % sampleReasons.length];
                const addedByEmployee = employees[i % employees.length]; // Cycle through admin, guru1, tu

                printQueue.push({
                    name: student.name,
                    class: student.class,
                    wali: student.wali,
                    reason: reason,
                    addedBy: addedByEmployee.name,
                    addedByUsername: addedByEmployee.username
                });
            }

            saveStudentDatabaseToLocalStorage();
            savePrintQueueToLocalStorage();
            updateDatabaseInfo();
            renderQueue(); // Render main dashboard queue
            renderPublicQueueSummary(); // Render public view queue
            console.log("Simulation complete. 20 students added to database, " + queueStudentsCount + " to queue.");
        }


        function generateSlipsPDF() {
            if (printQueue.length === 0) {
                showMessage("Antrian Kosong", "Daftar antrian kosong. Tidak ada data untuk dicetak.");
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'landscape', unit: 'mm', format: 'a4' });
            const pageW = doc.internal.pageSize.getWidth();
            const pageH = doc.internal.pageSize.getHeight();
            const panelW = pageW / 3;
            const panelH = pageH / 2;
            const margin = 8;

            const drawSlip = (x, y, student) => {
                doc.setDrawColor(150, 150, 150);
                doc.rect(x, y, panelW, panelH);

                const contentX = x + margin;
                const contentY = y + margin;
                const contentW = panelW - (margin * 2);
                let currentY = contentY;

                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                const title = "SURAT IJIN TIDAK MASUK SEKOLAH";
                const titleWidth = doc.getTextWidth(title);
                doc.text(title, x + (panelW / 2), currentY, { align: 'center' });
                const underlineY = currentY + 1;
                doc.setLineWidth(0.5);
                doc.line(x + (panelW / 2) - (titleWidth / 2), underlineY, x + (panelW / 2) + (titleWidth / 2), underlineY);
                currentY += 8;

                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                const p1 = "Surat ini menerangkan bahwa siswa tersebut dibawah ini telah diijinkan oleh orangtua/walinya untuk tidak masuk sekolah.";
                doc.text(p1, contentX, currentY, { maxWidth: contentW });
                currentY += 15;

                doc.text("Nama", contentX, currentY);
                doc.text(`: ${student.name}`, contentX + 20, currentY);
                currentY += 6;
                doc.text("Kelas", contentX, currentY);
                doc.text(`: ${student.class}`, contentX + 20, currentY);
                currentY += 6;
                doc.text("Keterangan", contentX, currentY);
                doc.text(`: ${student.reason}`, contentX + 20, currentY);
                currentY += 12;

                const p2 = "Mohon diteruskan kepada petugas presensi untuk dilaksanakan. Terima kasih.";
                doc.text(p2, contentX, currentY, { maxWidth: contentW });

                const signX = x + panelW - margin;
                const signY = y + panelH - margin;
                const formattedDate = activeDate.toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' });
                
                doc.text(`Jatirogo, ${formattedDate}`, signX, signY - 20, { align: 'right' });
                doc.text("Petugas,", signX, signY - 15, { align: 'right' });
                doc.text("Meri Wahyudi", signX, signY, { align: 'right' });
            };

            printQueue.forEach((student, index) => {
                const pageIndex = Math.floor(index / 6);
                if (pageIndex > 0 && index % 6 === 0) {
                    doc.addPage();
                }
                
                const slipIndexOnPage = index % 6;
                const col = slipIndexOnPage % 3;
                const row = Math.floor(slipIndexOnPage / 3);

                const x = col * panelW;
                const y = row * panelH;

                drawSlip(x, y, student);
            });
            
            const fileName = `surat-izin-${activeDate.toISOString().slice(0,10)}.pdf`;
            doc.output('dataurlnewwindow');
        }

        function generateReportPDF() {
            if (printQueue.length === 0) {
                showMessage("Antrian Kosong", "Daftar antrian kosong. Tidak ada data untuk dicetak.");
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });

            const tableColumn = ["No", "Nama Siswa", "Kelas", "Orang Tua/Wali", "Keterangan", "Ditambahkan Oleh"]; // Added new column
            const tableRows = printQueue.map((student, index) => [
                index + 1, student.name, student.class, student.wali, student.reason, student.addedBy || '-' // Display addedBy
            ]);
            
            const formattedDate = activeDate.toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' });
            const docTitle = "Laporan Ijin Siswa";
            const dateSubTitle = `Tanggal: ${formattedDate}`;
            const fileName = `laporan-izin-${activeDate.toISOString().slice(0,10)}.pdf`;

            const pageWidth = doc.internal.pageSize.getWidth();
            doc.setFontSize(18);
            doc.text(docTitle, pageWidth / 2, 15, { align: 'center' });
            doc.setFontSize(12);
            doc.text(dateSubTitle, pageWidth / 2, 22, { align: 'center' });

            doc.autoTable({
                head: [tableColumn],
                body: tableRows,
                startY: 30,
                theme: 'grid',
                headStyles: { fillColor: [241, 245, 249], textColor: [20, 20, 20] },
                styles: { font: 'Inter', fontSize: 12 },
                margin: { top: 10, right: 10, bottom: 10, left: 10 }
            });
            
            doc.output('dataurlnewwindow');
        }

        function downloadTemplate() {
            const headers = [
                "Nama",
                "Kelas",
                "Wali",
                "Nomor HP Wali"
            ];

            const data = [headers];

            const ws = XLSX.utils.aoa_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Data Siswa");
            XLSX.writeFile(wb, "template_data_siswa.xlsx");

            showMessage('Template Diunduh', 'Template Excel "template_data_siswa.xlsx" berhasil diunduh.');
        }
        
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) {
                showMessage('Peringatan', 'Tidak ada file yang dipilih.');
                event.target.value = '';
                return;
            }

            const fileName = file.name;
            const fileExtension = fileName.split('.').pop().toLowerCase();

            if (fileExtension !== 'xlsx') {
                showMessage('Format File Salah', 'Harap unggah file Excel dengan ekstensi .xlsx.');
                event.target.value = '';
                return;
            }

            const reader = new FileReader();

            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });

                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];

                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, raw: false });

                if (jsonData.length < 2) {
                    showMessage('File Kosong', 'File Excel kosong atau tidak memiliki data yang cukup.');
                    event.target.value = '';
                    return;
                }

                const headers = jsonData[0];
                const studentsDataRows = jsonData.slice(1);

                const requiredHeaders = ['Nama', 'Kelas'];
                const missingHeaders = requiredHeaders.filter(header => !headers.includes(header));

                if (missingHeaders.length > 0) {
                    showMessage('Header Tidak Lengkap', `File Excel tidak memiliki kolom yang diperlukan: ${missingHeaders.join(', ')}. Harap gunakan template yang benar.`);
                    event.target.value = '';
                    return;
                }

                const newStudents = [];
                let duplicatesFound = 0;
                const seenNamesInDatabase = new Set(studentDatabase.map(s => s.name.toLowerCase()));

                studentsDataRows.forEach(row => {
                    const nameIndex = headers.indexOf('Nama');
                    const classIndex = headers.indexOf('Kelas');
                    const waliIndex = headers.indexOf('Wali');
                    const nomorHpWaliIndex = headers.indexOf('Nomor HP Wali');

                    const name = row[nameIndex] ? String(row[nameIndex]).trim() : '';
                    const studentClass = row[classIndex] ? String(row[classIndex]).trim() : '';
                    const wali = waliIndex !== -1 && row[waliIndex] ? String(row[waliIndex]).trim() : '';
                    const nomorHpWali = nomorHpWaliIndex !== -1 && row[nomorHpWaliIndex] ? String(row[nomorHpWaliIndex]).trim() : '';

                    if (name && studentClass) {
                        if (!seenNamesInDatabase.has(name.toLowerCase())) {
                            seenNamesInDatabase.add(name.toLowerCase());
                            newStudents.push({
                                name: name,
                                class: studentClass,
                                wali: wali,
                                nomorHpWali: nomorHpWali
                            });
                        } else {
                            duplicatesFound++;
                        }
                    }
                });

                if (newStudents.length > 0) {
                    studentDatabase = [...studentDatabase, ...newStudents];
                    saveStudentDatabaseToLocalStorage();
                    updateDatabaseInfo();
                    let successMessage = `Berhasil mengimpor ${newStudents.length} siswa baru dari file Excel.`;
                    if (duplicatesFound > 0) {
                        successMessage += `\n${duplicatesFound} data duplikat (nama yang sama) diabaikan.`;
                    }
                    showMessage('Impor Berhasil', successMessage);
                } else {
                    showMessage('Tidak Ada Siswa Valid', 'Tidak ada siswa valid yang ditemukan di file Excel untuk diimpor.');
                }
                event.target.value = '';
            };

            reader.onerror = function(ex) {
                showMessage('Error Membaca File', 'Gagal membaca file. Pastikan format file Excel Anda benar.');
                console.error('File Reader Error:', ex);
                event.target.value = '';
            };

            reader.readAsArrayBuffer(file);
        }

        function handleSearch(e) {
            const query = e.target.value.toLowerCase();
            if (!autocompleteResults) return;
            autocompleteResults.innerHTML = '';

            if (query.length < 1) {
                autocompleteResults.classList.add('hidden');
                if (classInput) classInput.value = '';
                if (waliInput) waliInput.value = '';
                selectedStudent = null;
                if (addButton) addButton.disabled = true;
                return;
            }

            const matches = studentDatabase.filter(s => s.name.toLowerCase().includes(query)).slice(0, 10);
            
            if (matches.length > 0) {
                autocompleteResults.classList.remove('hidden');
                matches.forEach(match => {
                    const item = document.createElement('div');
                    item.className = 'autocomplete-item p-2 hover:bg-sky-500 hover:text-white cursor-pointer dark:hover:bg-blue-700';
                    item.textContent = `${match.name} (${match.class})`;
                    item.dataset.name = match.name;
                    item.dataset.class = match.class;
                    item.dataset.wali = match.wali || '';
                    item.dataset.nomorHpWali = match.nomorHpWali || '';
                    autocompleteResults.appendChild(item);
                });
            } else {
                autocompleteResults.classList.add('hidden');
            }
        }
        
        function selectStudentFromSearch(student) {
            selectedStudent = student;
            if (searchInput) searchInput.value = student.name;
            if (classInput) classInput.value = student.class;
            if (waliInput) waliInput.value = student.wali || '';
            if (autocompleteResults) autocompleteResults.classList.add('hidden');
            if (addButton) addButton.disabled = false;
        }

        function addToQueue(event) {
            event.preventDefault();
            if (!selectedStudent) { 
                showMessage('Peringatan', 'Pilih siswa dari hasil pencarian terlebih dahulu.'); 
                return; 
            }
            const waliName = waliInput.value.trim();
            if(!waliName) { 
                showMessage('Peringatan', 'Nama Orang Tua / Wali harus diisi.'); 
                return; 
            }
            const isAlreadyInQueue = printQueue.some(student => student.name.toLowerCase() === selectedStudent.name.toLowerCase());
            if (isAlreadyInQueue) {
                showMessage('Duplikat Antrian', `Siswa bernama "${selectedStudent.name}" sudah ada di dalam antrian.`);
                return;
            }
            // Add addedBy and addedByUsername to the student object when adding to queue
            printQueue.push({ 
                ...selectedStudent, 
                reason: reasonSelect.value, 
                wali: waliName,
                addedBy: loggedInEmployee ? loggedInEmployee.name : 'Unknown', // Capture employee name
                addedByUsername: loggedInEmployee ? loggedInEmployee.username : 'unknown' // Capture employee username for deletion logic
            });
            savePrintQueueToLocalStorage(); // Save printQueue
            selectedStudent = null;
            if (searchForm) searchForm.reset();
            if (addButton) addButton.disabled = true;
            renderQueue();
            if (classInput) classInput.value = '';
            if (waliInput) waliInput.value = '';
        }

        function removeFromQueue(index) {
            // Get the student object to be removed
            const studentToRemove = printQueue[index];

            // Check if user is admin or the one who added the entry
            if (loggedInEmployee && loggedInEmployee.role === 'admin') {
                // Admin has full access, proceed
                showConfirmation('Hapus Entri Antrian?', `Anda yakin ingin menghapus entri antrian untuk ${studentToRemove.name}?`, () => {
                    printQueue.splice(index, 1);
                    savePrintQueueToLocalStorage(); // Save printQueue
                    renderQueue();
                    showMessage('Entri Dihapus', `Entri antrian untuk ${studentToRemove.name} telah dihapus.`);
                });
            } else if (loggedInEmployee && studentToRemove.addedByUsername === loggedInEmployee.username) {
                // User added this entry, allow deletion
                showConfirmation('Hapus Entri Anda?', `Anda yakin ingin menghapus entri antrian yang Anda tambahkan untuk ${studentToRemove.name}?`, () => {
                    printQueue.splice(index, 1);
                    savePrintQueueToLocalStorage(); // Save printQueue
                    renderQueue();
                    showMessage('Entri Dihapus', `Entri antrian untuk ${studentToRemove.name} telah dihapus.`);
                });
            } else {
                // Not authorized
                showMessage('Tidak Diizinkan', 'Anda hanya dapat menghapus entri antrian yang Anda tambahkan sendiri, kecuali Anda adalah Admin.');
            }
        }

        function resetQueue() {
            showConfirmation('Hapus Data Hari Ini?', 'Anda yakin ingin menghapus semua data antrian hari ini? Ini tidak akan menghapus database siswa.', () => {
                printQueue = [];
                savePrintQueueToLocalStorage(); // Save empty printQueue
                renderQueue();
                showMessage('Data Dihapus', 'Data antrian hari ini telah dihapus.');
            });
        }

        function deleteDatabase() {
            showConfirmation('Hapus Seluruh Database?', 'PERINGATAN: Aksi ini tidak bisa dibatalkan. Seluruh data siswa yang dimuat akan hilang.', () => {
                studentDatabase = [];
                printQueue = []; // Also clear queue as student data is gone
                saveStudentDatabaseToLocalStorage();
                savePrintQueueToLocalStorage(); // Save empty printQueue
                if (searchInput) searchInput.value = '';
                updateDatabaseInfo();
                renderQueue();
                showMessage('Database Dihapus', 'Database telah dihapus.');
            });
        }

        function addStudentToDatabase(event) {
            event.preventDefault();
            const newNameInput = document.getElementById('manual-nama');
            const newClassInput = document.getElementById('manual-kelas');
            if (!newNameInput || !newClassInput) return;
            const newName = newNameInput.value.trim();
            const newClass = newClassInput.value.trim();

            if (!newName || !newClass) { 
                showMessage('Input Kosong', 'Nama dan Kelas siswa baru tidak boleh kosong.'); 
                return; 
            }
            if (studentDatabase.some(s => s.name.toLowerCase() === newName.toLowerCase())) {
                showMessage('Duplikat Siswa', 'Siswa dengan nama ini sudah ada di database.');
                return;
            }
            studentDatabase.push({ name: newName, class: newClass, wali: '', nomorHpWali: '' });
            saveStudentDatabaseToLocalStorage();
            updateDatabaseInfo();
            showMessage('Siswa Ditambahkan', `Siswa "${newName}" berhasil ditambahkan ke database.`);
            if (manualAddForm) manualAddForm.reset();
            if (manualAddModal) manualAddModal.classList.add('hidden');
        }

        // NEW: Add Employee
        function addEmployee(event) {
            event.preventDefault();
            const username = newEmployeeUsernameInput.value.trim();
            const password = newEmployeePasswordInput.value.trim();
            const name = newEmployeeNameInput.value.trim();
            const role = newEmployeeRoleSelect.value;

            if (!username || !password || !name) {
                showMessage('Input Kosong', 'Username, Password, dan Nama Lengkap pegawai tidak boleh kosong.');
                return;
            }

            if (employees.some(emp => emp.username.toLowerCase() === username.toLowerCase())) {
                showMessage('Duplikat Username', 'Username ini sudah digunakan. Silakan pilih username lain.');
                return;
            }

            employees.push({ username, password, name, role });
            saveEmployeesToLocalStorage();
            renderEmployeesTable(); // Re-render table
            addEmployeeForm.reset(); // Clear form
            showMessage('Pegawai Ditambahkan', `Pegawai "${name}" (${username}) berhasil ditambahkan.`);
        }

        // NEW: Delete Employee
        function deleteEmployee(usernameToDelete) {
            showConfirmation('Hapus Pegawai?', `Anda yakin ingin menghapus pegawai dengan username "${usernameToDelete}"?`, () => {
                // Prevent deleting the currently logged-in admin
                if (loggedInEmployee && loggedInEmployee.username === usernameToDelete && loggedInEmployee.role === 'admin') {
                    showMessage('Tidak Diizinkan', 'Anda tidak bisa menghapus akun admin yang sedang login.');
                    return;
                }

                const initialLength = employees.length;
                employees = employees.filter(emp => emp.username !== usernameToDelete);
                if (employees.length < initialLength) {
                    saveEmployeesToLocalStorage();
                    renderEmployeesTable(); // Re-render table
                    showMessage('Pegawai Dihapus', `Pegawai dengan username "${usernameToDelete}" berhasil dihapus.`);
                } else {
                    showMessage('Gagal Hapus', `Pegawai dengan username "${usernameToDelete}" tidak ditemukan.`);
                }
            });
        }

        // NEW: Handle Change Password
        function handleChangePassword(event) {
            event.preventDefault();
            const currentPass = currentPasswordInput.value;
            const newPass = newPasswordInput.value;
            const confirmNewPass = confirmNewPasswordInput.value;

            if (!currentPass || !newPass || !confirmNewPass) {
                showMessage('Input Kosong', 'Semua kolom password harus diisi.');
                return;
            }

            if (newPass !== confirmNewPass) {
                showMessage('Password Tidak Cocok', 'Password baru dan konfirmasi password tidak cocok.');
                return;
            }

            if (newPass === currentPass) {
                showMessage('Password Sama', 'Password baru tidak boleh sama dengan password saat ini.');
                return;
            }

            if (loggedInEmployee && loggedInEmployee.password === currentPass) {
                // Find the employee in the main employees array and update their password
                const employeeIndex = employees.findIndex(emp => emp.username === loggedInEmployee.username);
                if (employeeIndex !== -1) {
                    employees[employeeIndex].password = newPass;
                    loggedInEmployee.password = newPass; // Update current session's employee object
                    saveEmployeesToLocalStorage();
                    showMessage('Berhasil', 'Password berhasil diganti!');
                    changePasswordModal.classList.add('hidden');
                    changePasswordForm.reset();
                } else {
                    // This case should ideally not happen if loggedInEmployee is set correctly
                    showMessage('Error', 'Gagal menemukan data pengguna. Silakan coba login ulang.');
                    console.error('Logged-in employee not found in array during password change.');
                }
            } else {
                showMessage('Password Salah', 'Password saat ini salah.');
            }
        }


        function updateDatabaseInfo() {
            if (databaseInfo) databaseInfo.textContent = `${studentDatabase.length} siswa di database.`;
            if (searchInput) {
                searchInput.disabled = studentDatabase.length === 0;
                if(studentDatabase.length > 0) searchInput.focus();
            }
        }
        
        function updateDateDisplay() {
            if (!activeDateDisplay) return;
            activeDateDisplay.textContent = activeDate.toLocaleDateString('id-ID', {
                weekday: 'long', day: 'numeric', month: 'long', year: 'numeric'
            });
        }
        
        function applyTheme(theme) {
            if (theme === 'dark') {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
            localStorage.setItem('appTheme', theme);
            const themeRadio = document.querySelector(`input[name="theme-setting"][value="${theme}"]`);
            if(themeRadio) themeRadio.checked = true;
        }

        // --- EVENT LISTENERS ---
        // Open login form modal when 'Masuk' button is clicked
        if (loginButton) loginButton.addEventListener('click', () => {
            loginFormModal.classList.remove('hidden');
            loginUsernameInput.focus(); // Focus on username input
        });
        // Close login form modal
        if (closeLoginFormModalBtn) closeLoginFormModalBtn.addEventListener('click', () => {
            loginFormModal.classList.add('hidden');
            loginForm.reset(); // Clear form fields
        });
        // Handle login form submission
        if (loginForm) loginForm.addEventListener('submit', handleEmployeeLogin);

        // Logout button
        if (logoutButton) logoutButton.addEventListener('click', handleLogout);

        if (menuDatabase) menuDatabase.addEventListener('click', () => {
            if (submenuDatabase) submenuDatabase.classList.toggle('open');
            menuDatabase.classList.toggle('active');
        });
        if (fileInput) fileInput.addEventListener('change', handleFileUpload);
        if (downloadTemplateButton) downloadTemplateButton.addEventListener('click', downloadTemplate);
        if (deleteDatabaseButton) deleteDatabaseButton.addEventListener('click', deleteDatabase);
        if (searchInput) searchInput.addEventListener('input', handleSearch);
        if (searchForm) searchForm.addEventListener('submit', addToQueue);
        if (resetQueueButton) resetQueueButton.addEventListener('click', resetQueue);
        if (printPdfButton) printPdfButton.addEventListener('click', generateReportPDF);
        if (printSlipsButton) printSlipsButton.addEventListener('click', generateSlipsPDF);
        
        if (manualAddForm) manualAddForm.addEventListener('submit', addStudentToDatabase);
        if (openManualAddModalBtn) openManualAddModalBtn.addEventListener('click', () => {
            manualAddModal.classList.remove('hidden');
            document.getElementById('manual-nama').focus();
        });
        if (closeModalBtn) closeModalBtn.addEventListener('click', () => manualAddModal.classList.add('hidden'));
        if (manualAddModal) manualAddModal.addEventListener('click', (e) => {
            if (e.target === manualAddModal) manualAddModal.classList.add('hidden');
        });

        if (queueContainer) queueContainer.addEventListener('click', function(e) {
            if (e.target && e.target.classList.contains('remove-queue-btn')) {
                const index = parseInt(e.target.dataset.index, 10);
                // Pass the username of the entry adder for permission check
                removeFromQueue(index);
            }
        });
        
        if (autocompleteResults) autocompleteResults.addEventListener('click', function(e) {
            if (e.target && e.target.classList.contains('autocomplete-item')) {
                const student = {
                    name: e.target.dataset.name,
                    class: e.target.dataset.class,
                    wali: e.target.dataset.wali || '',
                    nomorHpWali: e.target.dataset.nomorHpWali || ''
                };
                selectStudentFromSearch(student);
            }
        });

        document.addEventListener('click', (e) => {
            if (searchForm && !searchForm.contains(e.target) && autocompleteResults) {
                autocompleteResults.classList.add('hidden');
            }
        });

        if (confirmOkBtn) confirmOkBtn.addEventListener('click', () => {
            if (confirmCancelBtn.classList.contains('hidden')) { 
                hideConfirmation();
            } else { 
                if (typeof onConfirmCallback === 'function') {
                    onConfirmCallback();
                }
                hideConfirmation();
            }
        });
        if (confirmCancelBtn) confirmCancelBtn.addEventListener('click', hideConfirmation);

        if(openSettingsModalBtn) openSettingsModalBtn.addEventListener('click', () => {
            settingsModal.classList.remove('hidden');
            document.querySelector(`input[name="date-setting"][value="${dateMode}"]`).checked = true;
            if (dateMode === 'manual') {
                manualDateInput.classList.remove('hidden');
                manualDateInput.valueAsDate = activeDate || new Date();
            } else {
                manualDateInput.classList.add('hidden');
            }
            document.querySelector(`input[name="theme-setting"][value="${currentTheme}"]`).checked = true;
        });
        if(closeSettingsModalBtn) closeSettingsModalBtn.addEventListener('click', () => settingsModal.classList.add('hidden'));
        if(settingsModal) settingsModal.addEventListener('click', (e) => {
            if(e.target === settingsModal) settingsModal.classList.add('hidden');
        });

        dateSettingRadios.forEach(radio => {
            radio.addEventListener('change', (e) => {
                dateMode = e.target.value;
                if (dateMode === 'manual') {
                    manualDateInput.classList.remove('hidden');
                    manualDateInput.valueAsDate = activeDate || new Date();
                    activeDate = new Date(manualDateInput.valueAsDate.getTime() + manualDateInput.valueAsDate.getTimezoneOffset() * 60000);
                } else {
                    manualDateInput.classList.add('hidden');
                    activeDate = new Date();
                }
                updateDateDisplay();
            });
        });
        
        if(manualDateInput) manualDateInput.addEventListener('change', (e) => {
            const selectedDate = new Date(e.target.value);
            const timezoneOffset = selectedDate.getTimezoneOffset() * 60000; 
            activeDate = new Date(selectedDate.getTime() + timezoneOffset);
            updateDateDisplay();
        });
        
themeSettingRadios.forEach(radio => {
            radio.addEventListener('change', (e) => {
                currentTheme = e.target.value;
                applyTheme(currentTheme);
            });
        });

        // NEW: Employee Management Event Listeners
        if (menuEmployeeManagement) menuEmployeeManagement.addEventListener('click', () => {
            if (submenuEmployeeManagement) submenuEmployeeManagement.classList.toggle('open');
            menuEmployeeManagement.classList.toggle('active');
        });
        if (openEmployeeManagementModalBtn) openEmployeeManagementModalBtn.addEventListener('click', () => {
            employeeManagementModal.classList.remove('hidden');
            renderEmployeesTable(); // Render table when modal opens
            newEmployeeUsernameInput.focus(); // Focus on first input
        });
        if (closeEmployeeManagementModalBtn) closeEmployeeManagementModalBtn.addEventListener('click', () => {
            employeeManagementModal.classList.add('hidden');
            addEmployeeForm.reset(); // Clear add form
        });
        if (employeeManagementModal) employeeManagementModal.addEventListener('click', (e) => {
            if (e.target === employeeManagementModal) {
                employeeManagementModal.classList.add('hidden');
                addEmployeeForm.reset();
            }
        });
        if (addEmployeeForm) addEmployeeForm.addEventListener('submit', addEmployee);
        if (employeeTableBody) employeeTableBody.addEventListener('click', function(e) {
            if (e.target && e.target.classList.contains('delete-employee-btn')) {
                const usernameToDelete = e.target.dataset.username;
                if (usernameToDelete) {
                    deleteEmployee(usernameToDelete);
                }
            }
        });

        // NEW: Change Password Event Listeners
        if (openChangePasswordModalBtn) openChangePasswordModalBtn.addEventListener('click', () => {
            changePasswordModal.classList.remove('hidden');
            currentPasswordInput.focus(); // Focus on current password input
        });
        if (closeChangePasswordModalBtn) closeChangePasswordModalBtn.addEventListener('click', () => {
            changePasswordModal.classList.add('hidden');
            changePasswordForm.reset(); // Clear form
        });
        if (changePasswordModal) changePasswordModal.addEventListener('click', (e) => {
            if (e.target === changePasswordModal) {
                changePasswordModal.classList.add('hidden');
                changePasswordForm.reset();
            }
        });
        if (changePasswordForm) changePasswordForm.addEventListener('submit', handleChangePassword);


        setInitialUIState(); // Initial UI setup
    }
    </script>
</body>
</html>
